---
title: "ext_risk_copula"
author: "Shyamolina Ghosh"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
library(abind)
source("mtime.R")
```

#Ricker model :
```{r sim_ricker, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

rc_ricker<-1 # transition from under to overcompensatory dynamics
r_bf_ricker<-2 # bifurcation parameter stable to unstable eqm

qrng<-runif(10000,min=0,max=r_bf_ricker)
qr<-quantile(qrng,probs=c(.025,.975))

rlist<-unique(c(seq(from=range(qr)[1],to=rc_ricker,length.out = 5),c(seq(from=rc_ricker,to=range(qr)[2],length.out = 5))))

numsims<-10000
numsteps<-25
numlocs<-5
K<-50
scl<-1
ext_thrs<-K/10
model<-"ricker"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

#initiate a dataframe to store ext risk at dispersal d=0 for all r
ricker_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) 
colnames(ricker_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

res_ricker_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,K)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_ricker_local<-abind(res_ricker_local,temp_mat,along = 3)
      
    ricker_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    ricker_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_ricker_local)<-list(NULL,cnm,anm)

saveRDS(ricker_extrisk_d0,paste(resloc,"ricker_extrisk_d0.RDS",sep=""))
saveRDS(res_ricker_local,paste(resloc,"res_ricker_local.RDS",sep=""))

# For global dispersion
res_ricker_global<-c()

for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,K)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_ricker_global<-abind(res_ricker_global,temp_mat,along = 3)
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_ricker_global)<-list(NULL,cnm,anm)
saveRDS(res_ricker_global,paste(resloc,"res_ricker_global.RDS",sep=""))
```

```{r fig_ricker, echo=F, results="hide",cache=T, cache.extra=list(seed,res_ricker_local,res_ricker_global)}
pdf(paste(resloc,"ricker_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_ricker_local)[3]){
  s<-res_ricker_local[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
  
  #---------------------------------------------------
  ## Allow a second plot on the same graph
  #par(new=TRUE)
  
  #ylm2<-c(-0.2,0.6)
  ## Plot the second plot and put axis scale on right
  #plot(s$d, s$pop_avg_acf_left, pch=16,  xlab="", ylab="", ylim=ylm2,xlim=c(0,1),
       #ylim=range(-0.1,0.1), xlim=c(0,1),cex.axis=1.5,bty="n",
  #     axes=FALSE, type="l", col="orange")
 # abline(h=0,lty="dotted",col="grey")
 # lines(s$d, s$pop_avg_acf_right, col="skyblue")
  
  ## a little farther out (line=3.2) to make room for labels
 # mtext("Avg. ACF",side=4,line=3.2,col="green4") 
 # axis(4, ylim=ylm2, las=1,col="green4",col.axis="green4")
  #---------------------------------------------------------
}
par(op)
dev.off()


pdf(paste(resloc,"ricker_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_ricker_global)[3]){
  s<-res_ricker_global[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()
```

```{r fig_ricker_extrisk_d0, echo=F,results="hide"}
set.seed(seed)

ricker_extrisk_d0<-readRDS("./Results/ricker/ricker_extrisk_d0.RDS")
numsims<-10000
ricker_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_left_d0)/numsims
ricker_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_left_d0)/numsims

ricker_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_right_d0)/numsims
ricker_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/ricker/ricker_extrisk_d0.pdf",height = 6,width=6)

plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_left_d0,col="red",type="b",
     ylim=c(0,1),xlim = c(0,2),xlab="r",ylab="Extinction risk",cex.lab=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025left,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975left,
       angle=90,length=0.1,col="red",code=3)
abline(v=rc_ricker,lty="dotted") #rc=1

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025right,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(0.2,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker_risk_local_disp}](./Results/ricker/ricker_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker__risk_global_disp}](./Results/ricker/ricker_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (ricker model with no dispersion : rc=1); numlocs=5, numsteps=25, numsims=10000\label{fig_ricker_risk_d0}](./Results/ricker/ricker_extrisk_d0.pdf){ width=40%, height=40% }


#Hassell Model :

```{r sim_hassell, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"hassell"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-100
scl<-1
rc_hassell<-((b/(b-1)))^b # transition from under to overcompensatory dynamics
r_bf_hassell<- ((b/(b-2)))^b # bifurcation parameter stable to unstable eqm

qrng<-runif(10000,min=0,max=r_bf_hussell)
qr<-quantile(qrng,probs=c(.025,.975))

rlist<-unique(c(seq(from=range(qr)[1],to=rc_hassell,length.out = 5),c(seq(from=rc_hassell,to=range(qr)[2],length.out = 5))))

hassell_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(hassell_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

res_hassell_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_hassell_local<-abind(res_hassell_local,temp_mat,along = 3)
      
    hassell_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    hassell_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_hassell_local)<-list(NULL,cnm,anm)

saveRDS(hassell_extrisk_d0,paste(resloc,"hassell_extrisk_d0.RDS",sep=""))
saveRDS(res_hassell_local,paste(resloc,"res_hassell_local.RDS",sep=""))

# For global dispersion
res_hassell_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_hassell_global<-abind(res_hassell_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_hassell_global)<-list(NULL,cnm,anm)
saveRDS(res_hassell_global,paste(resloc,"res_hassell_global.RDS",sep=""))
```

```{r fig_hassell, echo=F, results="hide",cache=T, cache.extra=list(seed,res_hassell_local,res_hassell_global)}
pdf(paste(resloc,"hassell_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_hassell_local)[3]){
  s<-res_hassell_local[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()


pdf(paste(resloc,"hassell_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_hassell_global)[3]){
  s<-res_hassell_global[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()
```

```{r fig_hassell_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
hassell_extrisk_d0<-readRDS("./Results/hassell/hassell_extrisk_d0.RDS")

hassell_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_left_d0)/numsims
hassell_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_left_d0)/numsims

hassell_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_right_d0)/numsims
hassell_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/hassell/hassell_extrisk_d0.pdf",height = 6,width=6)
plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(1.4,7.6),
     xlab="r",ylab="Extinction risk",cex.lab=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025left,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)
abline(v=rc_hassell,lty="dotted")

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025right,x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(2,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_hassell}](./Results/hassell/hassell_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_hassell}](./Results/hassell/hassell_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (hassell model with no dispersion : rc=2.73199); numlocs=5, numsteps=25, numsims=10000\label{fig_hassell_risk_d0}](./Results/hassell/hassell_extrisk_d0.pdf){ width=40%, height=40% }

#Maynard Smith Model :

```{r sim_msmith, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"msmith"
scl<-0.8

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-4

rc_msmith<-b/(b-1)
r_bf_msmith<-b/(b-2) # bifurcation parameter stable to unstable eqm

qrng<-runif(10000,min=0,max=r_bf_msmith)
qr<-quantile(qrng,probs=c(.025,.975))

rlist<-unique(c(seq(from=range(qr)[1],to=rc_msmith,length.out = 5),c(seq(from=rc_msmith,to=range(qr)[2],length.out = 5))))

msmith_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(msmith_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

#for local dispersal in D matrix 
res_msmith_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_msmith_local<-abind(res_msmith_local,temp_mat,along = 3)
      
    msmith_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    msmith_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_msmith_local)<-list(NULL,cnm,anm)

saveRDS(msmith_extrisk_d0,paste(resloc,"msmith_extrisk_d0.RDS",sep=""))
saveRDS(res_msmith_local,paste(resloc,"res_msmith_local.RDS",sep=""))

# For global dispersal in D matrix 
res_msmith_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_msmith_global<-abind(res_msmith_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_msmith_global)<-list(NULL,cnm,anm)
saveRDS(res_msmith_global,paste(resloc,"res_msmith_global.RDS",sep=""))
```

```{r fig_msmith, echo=F, results="hide",cache=T, cache.extra=list(seed,res_msmith_local,res_msmith_global)}
pdf(paste(resloc,"msmith_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_msmith_local)[3]){
  s<-res_msmith_local[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()


pdf(paste(resloc,"msmith_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_msmith_global)[3]){
  s<-res_msmith_global[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()
```

```{r fig_msmith_extrisk_d0, echo=F,results="hide"}
set.seed(seed)

msmith_extrisk_d0<-readRDS(paste(resloc,"msmith_extrisk_d0.RDS",sep=""))
numsims<-10000
msmith_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims
msmith_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims

msmith_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims
msmith_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims

pdf(paste(resloc,"msmith_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(1.2,2.8),
     xlab="r",ylab="Extinction risk",cex.lab=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025left,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)
abline(v=rc_msmith,lty="dotted")

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025right,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(1.5,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3, scl=0.8) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary_scl_0.8}](./Results/msmith_scl_0.8/msmith_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3, scl=0.8) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary_scl_0.8}](./Results/msmith_scl_0.8/msmith_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model with no dispersion : rc=4/3, scl=0.8); numlocs=5, numsteps=25, numsims=10000\label{fig_msmith_risk_d0_scl_0.8}](./Results/msmith_scl_0.8/msmith_extrisk_d0.pdf){ width=40%, height=40% }

# Pennycuick model :

```{r get_rc_pennycuick,echo=F,results="hide",cache=T,cache.extra=list(seed,mtime("1var_pop_model_bifurcation.R"))}
source("./1var_pop_model_bifurcation.R")
a_pennycuick<-0.1
b_pennycuick<-0.1
eps<-1e-10 #you can change it upto which decimal point you want it to be exact
rlist<-seq(from=4.3231657,to=4.3231659,by=eps)
res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r,a_pennycuick,b_pennycuick),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)

rc_pennycuick<-rlist[which.min(abs(res_pennycuick-0))]
formatC(rc_pennycuick,digits = 10, format="f") # accurate upto 10th decimal

# This is to find the critical r value where stable to unstable eqm occurs
rlist<-seq(from=9.4672389,to=9.46724,by=eps)
#formatC(rlist,digits = 14, format="f") 

res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r=r,a_pennycuick,b_pennycuick),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)
#fp<-0
fp<--1
r_bf_pennycuick<-rlist[which.min(abs(res_pennycuick-fp))]
#formatC(rc_pen_uns,digits = 14, format="f") 
```

```{r sim_pennycuick, echo=F,  results="hide", cache=T, cache.extra=list(seed,a_pennycuick,b_pennycuick,rc_pennycuick,r_bf_pennycuick,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"pennycuick"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-a_pennycuick
b<-b_pennycuick
scl<-1

qrng<-runif(10000,min=0,max=r_bf_pennycuick)
qr<-quantile(qrng,probs=c(.025,.975))

rlist<-unique(c(seq(from=range(qr)[1],to=rc_pennycuick,length.out = 5),c(seq(from=rc_pennycuick,to=range(qr)[2],length.out = 5))))

pennycuick_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) # a dataframe to store ext risk at dispersal d=0 for all r
colnames(pennycuick_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

#for local dispersal in D matrix 
res_pennycuick_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_pennycuick_local<-abind(res_pennycuick_local,temp_mat,along = 3)
      
    pennycuick_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    pennycuick_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_pennycuick_local)<-list(NULL,cnm,anm)

saveRDS(pennycuick_extrisk_d0,paste(resloc,"pennycuick_extrisk_d0.RDS",sep=""))
saveRDS(res_pennycuick_local,paste(resloc,"res_pennycuick_local.RDS",sep=""))

# For global dispersal in D matrix 
res_pennycuick_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_pennycuick_global<-abind(res_pennycuick_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_pennycuick_global)<-list(NULL,cnm,anm)
saveRDS(res_pennycuick_global,paste(resloc,"res_pennycuick_global.RDS",sep=""))
```

```{r fig_pennycuick, echo=F, results="hide",cache=T, cache.extra=list(seed,res_pennycuick_local,res_pennycuick_global)}
pdf(paste(resloc,"pennycuick_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_pennycuick_local)[3]){
  s<-res_pennycuick_local[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()


pdf(paste(resloc,"pennycuick_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_pennycuick_global)[3]){
  s<-res_pennycuick_global[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()
```

```{r fig_pennycuick_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
pennycuick_extrisk_d0<-readRDS("./Results/pennycuick/pennycuick_extrisk_d0.RDS")

pennycuick_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_left_d0)/numsims
pennycuick_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_left_d0)/numsims

pennycuick_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_right_d0)/numsims
pennycuick_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/pennycuick/pennycuick_extrisk_d0.pdf",height = 6,width=6)
plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),
     xlim = c(2,7),xlab="r",ylab="Extinction risk",cex.lab=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025left,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)
abline(v=rc_pennycuick,lty="dotted")

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025right,x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(3,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model : a = 0.1, b = 0.1) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary}](./Results/pennycuick/pennycuick_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model : a = 0.1, b = 0.1) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary}](./Results/pennycuick/pennycuick_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model with no dispersion : rc=4.3231657); numlocs=5, numsteps=25, numsims=10000\label{fig_pennycuick_risk_d0}](./Results/pennycuick/pennycuick_extrisk_d0.pdf){ width=40%, height=40% }

# Verhulst model :

```{r sim_verhulst, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"verhulst"
scl<-2.5

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
p0<-1

rc_verhulst<-1 # transition from under to overcompensatory dynamics
r_bf_verhulst<-2 # bifurcation parameter stable to unstable eqm

qrng<-runif(10000,min=0,max=r_bf_verhulst)
qr<-quantile(qrng,probs=c(.025,.975))

rlist<-unique(c(seq(from=range(qr)[1],to=rc_verhulst,length.out = 5),c(seq(from=rc_verhulst,to=range(qr)[2],length.out = 5))))

verhulst_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(verhulst_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

#for local dispersal in D matrix 
res_verhulst_local<-c()

for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-r
    ext_thrs<-p0/10
    
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_verhulst_local<-abind(res_verhulst_local,temp_mat,along = 3)
      
    verhulst_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    verhulst_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_verhulst_local)<-list(NULL,cnm,anm)

saveRDS(verhulst_extrisk_d0,paste(resloc,"verhulst_extrisk_d0.RDS",sep=""))
saveRDS(res_verhulst_local,paste(resloc,"res_verhulst_local.RDS",sep=""))

# For global dispersal in D matrix 
res_verhulst_global<-c()
for(r in rlist){
    params<-r
    ext_thrs<-p0/10
    
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,plotteron = F,resloc=resloc,checkon=F,getacf=F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
    res_verhulst_global<-abind(res_verhulst_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_verhulst_global)<-list(NULL,cnm,anm)
saveRDS(res_verhulst_global,paste(resloc,"res_verhulst_global.RDS",sep=""))
```

```{r fig_verhulst, echo=F, results="hide",cache=T, cache.extra=list(seed,res_verhulst_local,res_verhulst_global)}
pdf(paste(resloc,"verhulst_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_verhulst_local)[3]){
  s<-res_verhulst_local[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("topleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()


pdf(paste(resloc,"verhulst_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_verhulst_global)[3]){
  s<-res_verhulst_global[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("topleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()
```

```{r fig_verhulst_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
verhulst_extrisk_d0<-readRDS(paste(resloc,"verhulst_extrisk_d0.RDS",sep=""))

verhulst_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_left_d0)/numsims
verhulst_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_left_d0)/numsims

verhulst_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_right_d0)/numsims
verhulst_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_right_d0)/numsims

pdf(paste(resloc,"verhulst_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(verhulst_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025left,x1=verhulst_extrisk_d0$r,
       y1=verhulst_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)
abline(v=rc_verhulst,lty="dotted")

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025right,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(0.5,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```


![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Verhulst model : rc = 1, scl=2.5) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_verhulst_r_vary_scl_2.5}](./Results/verhulst_scl_2.5/verhulst_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Verhulst model : rc = 1, scl=2.5) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_verhulst_r_vary_scl_2.5}](./Results/verhulst_scl_2.5/verhulst_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Verhulst model with no dispersion : rc = 1, scl=2.5); numlocs=5, numsteps=25, numsims=10000\label{fig_verhulst_risk_d0_scl_2.5}](./Results/verhulst_scl_2.5/verhulst_extrisk_d0.pdf){ width=40%, height=40% }

# Austin Brewer model :
  
```{r sim_abrewer, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"austinbrewer"
scl<-0.8

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
s<-0.2
K<-50

rc_abrewer<-1/(K*(1-exp(-s*K))) # transition from under to overcompensatory dynamics
r_bf_abrewer<-2*rc_abrewer # bifurcation parameter stable to unstable eqm

qrng<-runif(10000,min=0,max=r_bf_abrewer)
qr<-quantile(qrng,probs=c(.025,.975))

rlist<-unique(c(seq(from=range(qr)[1],to=rc_abrewer,length.out = 5),c(seq(from=rc_abrewer,to=range(qr)[2],length.out = 5))))

abrewer_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(abrewer_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

#for local dispersal in D matrix 
res_abrewer_local<-c()

for(i in c(1:length(rlist))){
  r<- rlist[i]
  K<-50
  s<-0.2
  p0<-K
  params<-c(r,K,s)
  ext_thrs<-p0/10
  
  s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
               scl=scl,model=model,disp_everywhere=F,plotteron = F,resloc=resloc,checkon=F,getacf=F)
  
  temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
  res_abrewer_local<-abind(res_abrewer_local,temp_mat,along = 3)
  
  abrewer_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
  abrewer_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_abrewer_local)<-list(NULL,cnm,anm)

saveRDS(abrewer_extrisk_d0,paste(resloc,"abrewer_extrisk_d0.RDS",sep=""))
saveRDS(res_abrewer_local,paste(resloc,"res_abrewer_local.RDS",sep=""))

# For global dispersal in D matrix 
res_abrewer_global<-c()
for(r in rlist){
  #cat("r=",r,"\n")
  K<-50
  s<-0.2
  p0<-K
  params<-c(r,K,s)
  ext_thrs<-p0/10
  
  s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
               scl=scl,model=model,disp_everywhere=T,plotteron = F,resloc=resloc,checkon=F,getacf=F)
  
  temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$pop_avg_acf_left,s$pop_avg_acf_right)
  res_abrewer_global<-abind(res_abrewer_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","pop_avg_acf_left","pop_avg_acf_right")
dimnames(res_abrewer_global)<-list(NULL,cnm,anm)
saveRDS(res_abrewer_global,paste(resloc,"res_abrewer_global.RDS",sep=""))
```

```{r fig_abrewer, echo=F, results="hide",cache=T, cache.extra=list(seed,res_abrewer_local,res_abrewer_global)}
pdf(paste(resloc,"abrewer_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_abrewer_local)[3]){
  s<-res_abrewer_local[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()


pdf(paste(resloc,"abrewer_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))

for(i in 1:dim(res_abrewer_global)[3]){
  s<-res_abrewer_global[,,i]
  s<-as.data.frame(s)
  
  plot(s$d,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(s$d,s$risk_right,type="b",col="blue")
  legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", rlist[i]))
}
par(op)
dev.off()
```

```{r fig_abrewer_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
abrewer_extrisk_d0<-readRDS(paste(resloc,"abrewer_extrisk_d0.RDS",sep=""))

abrewer_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_left_d0)/numsims
abrewer_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_left_d0)/numsims
abrewer_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_right_d0)/numsims
abrewer_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_right_d0)/numsims
pdf(paste(resloc,"abrewer_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(abrewer_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025left,x1=abrewer_extrisk_d0$r,
       y1=abrewer_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)
abline(v=rc_abrewer,lty="dotted")

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025right,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(0.005,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Austin Brewer model : K = 50, s = 0.2, rc = 0.02000091, scl=0.8) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_abrewer_r_vary_scl_0.8}](./Results/austinbrewer_scl_0.8/abrewer_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Austin Brewer model : K = 50, s = 0.2, rc = 0.02000091, scl=0.8) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_abrewer_r_vary_scl_0.8}](./Results/austinbrewer_scl_0.8/abrewer_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Austin Brewer model with no dispersion : rc=0.02000091, scl=0.8); numlocs=5, numsteps=25, numsims=10000\label{fig_abrewer_risk_d0_scl_0.8}](./Results/austinbrewer_scl_0.8/abrewer_extrisk_d0.pdf){ width=40%, height=40% }

  
  
  
  
  
  
  
  
  







