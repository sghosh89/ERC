---
title: "ext_risk_copula"
author: "Shyamolina Ghosh"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
source("mtime.R")
source("mydispersal.R")
```

#Ricker model :
```{r fig_ricker, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

rlist<-c(0,0.1,0.3,0.5,0.7,0.9,1.0,1.1,1.3,1.5,1.7,1.9) #rc = 1
numsims<-10000
numsteps<-25
numlocs<-5
a<-NA
b<-NA
K<-50
scl<-1
ext_thrs<-K/10
model<-"ricker"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

ricker_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(ricker_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf(paste(resloc,"ricker_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<- rlist[i]
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,r=r,K=K,a=a,b=b,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    ricker_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    ricker_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(ricker_extrisk_d0,paste(resloc,"ricker_extrisk_d0.RDS",sep=""))

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf(paste(resloc,"ricker_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    #cat("r=",r,"\n")
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,r=r,K=K,a=a,b=b,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker_risk_local_disp}](./Results/ricker/ricker_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker__risk_global_disp}](./Results/ricker/ricker_ext_risk_global_disp.pdf){ width=40%, height=40% }

<!--
In order to study the effects of non-Normal copula structure on extinction risk for metapopulations with different dispersal rules, we examined the following generalized multiple patch model where local population dynamics at each patch were governed by the lewinton-Cohen model ($r=0$) or Ricker model ($r \neq 0$) as the case may be;

\begin{equation}\label{eq.extrisk_model}
P(t+1) = \exp\left [  r\left ( 1-\frac{P(t)}{K} \right ) + \epsilon(t) \right ] P(t)
\end{equation}

$r$ is the liner growth rate and $K$ is the carrying capacity of the environment. $\epsilon$ is the environmental noise which might take stronger right tail (means stronger upper tail)  or stronger left tail (means stronger lower tail) dependence. We then considered each population $P(t+1)$ was updated depending upon $D$, the dispersal matrix, which could take either forms; one case when each population patch on a linear chain interacted with its two nearest neighbors (we called it local dispersion) or when any patch was allowed to interact with the rest of all (we called it as global dispersion). We simulated Eq. \ref{eq.extrisk_model} for $10000$ simulations and calculated extinction risk after $10$ years with different possibilities (for code see [mydispersal.R](https://github.com/sghosh89/BIVAN/blob/master/mydispersal.R)) and summarized our findings as follows;


- LC model (r=0) :

    * For LC model, as expected, when extinction risk calculated after $10$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one. [see first subplot of Fig. \ref{fig_ricker_risk_local_disp} and Fig. \ref{fig_ricker_risk_global_disp}]

- Ricker model (r $\neq$ 0):

    * For ricker model when extinction risk calculated after $10$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one upto $r=0.7$. For $r>0.7$, extinction risk is greater for data came from right tail dependent environmental fluctuations (rc =1, under- to over-compensatory dynamics). [see Fig. \ref{fig_rikcer_risk_local_disp} - \ref{fig_ricker_risk_global_disp}]
 
    * With increasing $K$ from $50$ to $200$, extinction risk in both case gets decreased as expected. (produce the figs if not done yet)
  
With increasing number of patches from $5$ to $25$, extinction risk decreased [for a fixed $d$] ; [see Fig. \ref{fig_risk_numlocs_effect_local_disp} - Fig. \ref{fig_risk_numlocs_effect_global_disp}] for both model. (produce the figs if not done yet)
-->

#Hassell Model :

```{r fig_hassell, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"hassell"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

rlist<-seq(from=1.5,to=7.5,by=0.5)
numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-100
scl<-1
rc<-((b/(b-1)))^b # critical value of r from monotonic to osc steady state approach transition 
rlist<-sort(c(rlist,rc))


hassell_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(hassell_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

# plot for local dispersal in D matrix 
pdf(paste(resloc,"hassell_ext_risk_local_disp.pdf",sep=""),height=9,width=15)
op<-par(mfrow=c(3,5),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<- rlist[i]
    K_e<-((r^(1/b))-1)/a
    K<-K_e
    ext_thrs<-K/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,r=r,K=K,a=a,b=b,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    hassell_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    hassell_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(hassell_extrisk_d0,paste(resloc,"hassell_extrisk_d0.RDS",sep=""))

# plot for local dispersal in D matrix 
pdf(paste(resloc,"hassell_ext_risk_global_disp.pdf",sep=""),height=9,width=15)
op<-par(mfrow=c(3,5),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    #cat("r=",r,"\n")
    K_e<-((r^(1/b))-1)/a
    K<-K_e
    ext_thrs<-K/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,r=r,K=K,a=a,b=b,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```


![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_hassell}](./Results/hassell/hassell_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_hassell}](./Results/hassell/hassell_ext_risk_global_disp.pdf){ width=40%, height=40% }

#Maynard Smith Model :

```{r fig_msmith_r_vary_localdisp, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"msmith"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

rlist<-seq(from=1.2,to=2.8,by=0.2)
numsims<-10000
numsteps<-25
numlocs<-5
a<-1
b<-3
scl<-1

#msmith_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
#colnames(msmith_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    K_e<-((r-1)^(1/b))/a
    K<-K_e
    ext_thrs<-K/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,r=r,K=K,a=a,b=b,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

# plot for global dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    K_e<-((r-1)^(1/b))/a
    K<-K_e
    ext_thrs<-K/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,r=r,K=K,a=a,b=b,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 1.7) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary}](./Results/msmith/msmith_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 1.7) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary}](./Results/msmith/msmith_ext_risk_global_disp.pdf){ width=40%, height=40% }


