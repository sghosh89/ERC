---
title: "ext_risk_copula"
author: "Shyamolina Ghosh"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
source("mtime.R")
source("mydispersal.R")
```

#Ricker model :
```{r fig_ricker, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

rlist<-c(0,0.1,0.3,0.5,0.7,0.9,1.0,1.1,1.3,1.5,1.7,1.9) #rc = 1
numsims<-10000
numsteps<-25
numlocs<-5
K<-50
scl<-1
ext_thrs<-K/10
model<-"ricker"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

ricker_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(ricker_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf(paste(resloc,"ricker_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,K)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    ricker_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    ricker_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(ricker_extrisk_d0,paste(resloc,"ricker_extrisk_d0.RDS",sep=""))

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
pdf(paste(resloc,"ricker_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,K)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```

```{r fig_ricker_extrisk_d0, echo=F,results="hide"}
set.seed(seed)

ricker_extrisk_d0<-readRDS("./Results/ricker/ricker_extrisk_d0.RDS")
numsims<-10000
ricker_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_left_d0)/numsims
ricker_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_left_d0)/numsims

ricker_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_right_d0)/numsims
ricker_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/ricker/ricker_extrisk_d0.pdf",height = 6,width=6)

plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(0,2),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025left,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025right,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(0.2,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker_risk_local_disp}](./Results/ricker/ricker_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker__risk_global_disp}](./Results/ricker/ricker_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (ricker model with no dispersion : rc=1); numlocs=5, numsteps=25, numsims=10000\label{fig_ricker_risk_d0}](./Results/ricker/ricker_extrisk_d0.pdf){ width=40%, height=40% }


<!--
In order to study the effects of non-Normal copula structure on extinction risk for metapopulations with different dispersal rules, we examined the following generalized multiple patch model where local population dynamics at each patch were governed by the lewinton-Cohen model ($r=0$) or Ricker model ($r \neq 0$) as the case may be;

\begin{equation}\label{eq.extrisk_model}
P(t+1) = \exp\left [  r\left ( 1-\frac{P(t)}{K} \right ) + \epsilon(t) \right ] P(t)
\end{equation}

$r$ is the liner growth rate and $K$ is the carrying capacity of the environment. $\epsilon$ is the environmental noise which might take stronger right tail (means stronger upper tail)  or stronger left tail (means stronger lower tail) dependence. We then considered each population $P(t+1)$ was updated depending upon $D$, the dispersal matrix, which could take either forms; one case when each population patch on a linear chain interacted with its two nearest neighbors (we called it local dispersion) or when any patch was allowed to interact with the rest of all (we called it as global dispersion). We simulated Eq. \ref{eq.extrisk_model} for $10000$ simulations and calculated extinction risk after $10$ years with different possibilities (for code see [mydispersal.R](https://github.com/sghosh89/BIVAN/blob/master/mydispersal.R)) and summarized our findings as follows;


- LC model (r=0) :

    * For LC model, as expected, when extinction risk calculated after $10$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one. [see first subplot of Fig. \ref{fig_ricker_risk_local_disp} and Fig. \ref{fig_ricker_risk_global_disp}]

- Ricker model (r $\neq$ 0):

    * For ricker model when extinction risk calculated after $10$ years, was plotted against each varying $d$ (=degree of dispersion), we found that extinction risk was higher for data came from left tail dependent environmental fluctuations than right tail dependent one upto $r=0.7$. For $r>0.7$, extinction risk is greater for data came from right tail dependent environmental fluctuations (rc =1, under- to over-compensatory dynamics). [see Fig. \ref{fig_rikcer_risk_local_disp} - \ref{fig_ricker_risk_global_disp}]
 
    * With increasing $K$ from $50$ to $200$, extinction risk in both case gets decreased as expected. (produce the figs if not done yet)
  
With increasing number of patches from $5$ to $25$, extinction risk decreased [for a fixed $d$] ; [see Fig. \ref{fig_risk_numlocs_effect_local_disp} - Fig. \ref{fig_risk_numlocs_effect_global_disp}] for both model. (produce the figs if not done yet)
-->

#Hassell Model :

```{r fig_hassell, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"hassell"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

rlist<-seq(from=1.5,to=7.5,by=0.5)
numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-100
scl<-1
rc<-((b/(b-1)))^b # critical value of r from monotonic to osc steady state approach transition 
rlist<-sort(c(rlist,rc))


hassell_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(hassell_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

# plot for local dispersal in D matrix 
pdf(paste(resloc,"hassell_ext_risk_local_disp.pdf",sep=""),height=9,width=15)
op<-par(mfrow=c(3,5),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<- rlist[i]
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    hassell_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    hassell_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(hassell_extrisk_d0,paste(resloc,"hassell_extrisk_d0.RDS",sep=""))

# plot for local dispersal in D matrix 
pdf(paste(resloc,"hassell_ext_risk_global_disp.pdf",sep=""),height=9,width=15)
op<-par(mfrow=c(3,5),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    #cat("r=",r,"\n")
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```

```{r fig_hassell_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
hassell_extrisk_d0<-readRDS("./Results/hassell/hassell_extrisk_d0.RDS")

hassell_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_left_d0)/numsims
hassell_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_left_d0)/numsims

hassell_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_right_d0)/numsims
hassell_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/hassell/hassell_extrisk_d0.pdf",height = 6,width=6)
plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(1.4,7.6),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025left,x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025right,x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(2,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_hassell}](./Results/hassell/hassell_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_hassell}](./Results/hassell/hassell_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (hassell model with no dispersion : rc=2.73199); numlocs=5, numsteps=25, numsims=10000\label{fig_hassell_risk_d0}](./Results/hassell/hassell_extrisk_d0.pdf){ width=40%, height=40% }

#Maynard Smith Model :

```{r fig_msmith_scl_1, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"msmith"
scl<-1

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-4


rc<-b/(b-1)
rlist<-sort(c(seq(from=1.2,to=2.8,by=0.2),rc))

msmith_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(msmith_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    msmith_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    msmith_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(msmith_extrisk_d0,paste(resloc,"msmith_extrisk_d0.RDS",sep=""))

# plot for global dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_global_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

# Plot ext_risk_d0
msmith_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims
msmith_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims

msmith_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims
msmith_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims

pdf(paste(resloc,"msmith_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(1.2,2.8),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025left,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025right,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(1.5,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary}](./Results/msmith_scl_1/msmith_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary}](./Results/msmith_scl_1/msmith_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model with no dispersion : rc=4/3); numlocs=5, numsteps=25, numsims=10000\label{fig_msmith_risk_d0}](./Results/msmith_scl_1/msmith_extrisk_d0.pdf){ width=40%, height=40% }

```{r fig_msmith_scl_0.8, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"msmith"
scl<-0.8

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-4

rc<-b/(b-1)
rlist<-sort(c(seq(from=1.2,to=2.8,by=0.2),rc))

msmith_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(msmith_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    msmith_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    msmith_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(msmith_extrisk_d0,paste(resloc,"msmith_extrisk_d0.RDS",sep=""))

# plot for global dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_global_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

# Plot ext_risk_d0
msmith_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims
msmith_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims

msmith_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims
msmith_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims

pdf(paste(resloc,"msmith_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(1.2,2.8),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025left,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025right,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(1.5,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3, scl=0.8) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary_scl_0.8}](./Results/msmith_scl_0.8/msmith_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3, scl=0.8) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary_scl_0.8}](./Results/msmith_scl_0.8/msmith_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model with no dispersion : rc=4/3, scl=0.8); numlocs=5, numsteps=25, numsims=10000\label{fig_msmith_risk_d0_scl_0.8}](./Results/msmith_scl_0.8/msmith_extrisk_d0.pdf){ width=40%, height=40% }

# Pennycuick model :

```{r get_rc_pennycuick,echo=F,cache=T,cache.extra=list(seed,mtime("1var_pop_model_bifurcation.R"))}
source("./1var_pop_model_bifurcation.R")
a_pennycuick<-0.1
b_pennycuick<-0.1
eps<-1e-10 #you can change it upto which decimal point you want it to be exact
rlist<-seq(from=4.3231657,to=4.3231658,by=eps)
res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r,a,b),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)

rc_pennycuick<-rlist[which.min(abs(res_pennycuick-0))]
formatC(rc_pennycuick,digits = 10, format="f") # accurate upto 10th decimal
```

```{r fig_pennycuick, echo=F,  results="hide", cache=T, cache.extra=list(seed,a_pennycuick,b_pennycuick,rc_pennycuick,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
model<-"pennycuick"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-a_pennycuick
b<-b_pennycuick
scl<-1

rlist<-sort(c(seq(from=2,to=7,by=0.5),rc_pennycuick))

pennycuick_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) # a dataframe to store ext risk at dispersal d=0 for all r
colnames(pennycuick_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"pennycuick_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    pennycuick_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    pennycuick_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(pennycuick_extrisk_d0,paste(resloc,"pennycuick_extrisk_d0.RDS",sep=""))

# plot for global dispersal in D matrix 
pdf(paste(resloc,"pennycuick_ext_risk_global_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```

```{r fig_pennycuick_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
pennycuick_extrisk_d0<-readRDS("./Results/pennycuick/pennycuick_extrisk_d0.RDS")

pennycuick_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_left_d0)/numsims
pennycuick_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_left_d0)/numsims

pennycuick_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_right_d0)/numsims
pennycuick_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/pennycuick/pennycuick_extrisk_d0.pdf",height = 6,width=6)
plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),
     xlim = c(2,7),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025left,x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025right,x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(3,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model : a = 0.1, b = 0.1) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary}](./Results/pennycuick/pennycuick_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model : a = 0.1, b = 0.1) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary}](./Results/pennycuick/pennycuick_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model with no dispersion : rc=4.3231657); numlocs=5, numsteps=25, numsims=10000\label{fig_pennycuick_risk_d0}](./Results/pennycuick/pennycuick_extrisk_d0.pdf){ width=40%, height=40% }


# Austin Brewer model :

