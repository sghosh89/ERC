---
title: "ext_risk_copula"
author: "Shyamolina Ghosh"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
source("mtime.R")
source("mydispersal.R")
```

#Ricker model :
```{r fig_ricker, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
library(abind)
rlist<-c(0,0.1,0.3,0.5,0.7,0.9,1.0,1.1,1.3,1.5,1.7,1.9) #rc = 1
numsims<-10000
numsteps<-25
numlocs<-5
K<-50
scl<-1
ext_thrs<-K/10
model<-"ricker"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

ricker_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(ricker_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

res_ricker_local<-c()

# plot for local dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
#pdf(paste(resloc,"ricker_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
#op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,K)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$avg_acf_left,s$avg_acf_right)
    
    res_ricker_local<-abind(res_ricker_local,temp_mat)
      
    ricker_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    ricker_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    #plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
    #     panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    #lines(s$d_seq,s$risk_right,type="b",col="blue")
    #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
    #mtext(paste0("r = ", r))
}
#par(op)
#dev.off()
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_left","risk_right","avgACF_left","avgACF_right")
dimnames(res_ricker_local)<-list(NULL,cnm,anm)

saveRDS(ricker_extrisk_d0,paste(resloc,"ricker_extrisk_d0.RDS",sep=""))
saveRDS(res_ricker_local,paste(resloc,"res_ricker_local.RDS",sep=""))

res_ricker_global<-c()
# plot for global dispersal in D matrix ; r=0 for LC model, r!=0 for Ricker model
#pdf(paste(resloc,"ricker_ext_risk_global_disp.pdf",sep=""),height=9,width=12)
#op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,K)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    
    temp_mat<-cbind(s$d_seq,s$risk_left,s$risk_right,s$avg_acf_left,s$avg_acf_right)
    colnames(temp_mat)<-c("d","risk_left","risk_right","avgACF_left","avgACF_right")
    
    res_ricker_global<-abind(res_ricker_global,temp_mat)
    #plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",
    #     panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    #lines(s$d_seq,s$risk_right,type="b",col="blue")
    #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    #mtext(paste0("r = ", r))
}
#par(op)
#dev.off()
```

```{r fig_ricker_extrisk_d0, echo=F,results="hide"}
set.seed(seed)

ricker_extrisk_d0<-readRDS("./Results/ricker/ricker_extrisk_d0.RDS")
numsims<-10000
ricker_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_left_d0)/numsims
ricker_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_left_d0)/numsims

ricker_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_right_d0)/numsims
ricker_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/ricker/ricker_extrisk_d0.pdf",height = 6,width=6)

plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(0,2),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025left,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025right,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(0.2,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker_risk_local_disp}](./Results/ricker/ricker_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Lewinton-Cohen model : $r=0$, Ricker model : $r\neq0$) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_ricker__risk_global_disp}](./Results/ricker/ricker_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (ricker model with no dispersion : rc=1); numlocs=5, numsteps=25, numsims=10000\label{fig_ricker_risk_d0}](./Results/ricker/ricker_extrisk_d0.pdf){ width=40%, height=40% }


#Hassell Model :

```{r fig_hassell, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"hassell"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

rlist<-seq(from=1.5,to=7.5,by=0.5)
numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-100
scl<-1
rc<-((b/(b-1)))^b # critical value of r from monotonic to osc steady state approach transition 
rlist<-sort(c(rlist,rc))


hassell_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(hassell_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")

# plot for local dispersal in D matrix 
pdf(paste(resloc,"hassell_ext_risk_local_disp.pdf",sep=""),height=9,width=15)
op<-par(mfrow=c(3,5),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<- rlist[i]
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    hassell_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    hassell_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(hassell_extrisk_d0,paste(resloc,"hassell_extrisk_d0.RDS",sep=""))

# plot for local dispersal in D matrix 
pdf(paste(resloc,"hassell_ext_risk_global_disp.pdf",sep=""),height=9,width=15)
op<-par(mfrow=c(3,5),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    #cat("r=",r,"\n")
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```

```{r fig_hassell_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
hassell_extrisk_d0<-readRDS("./Results/hassell/hassell_extrisk_d0.RDS")

hassell_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_left_d0)/numsims
hassell_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_left_d0)/numsims

hassell_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_right_d0)/numsims
hassell_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/hassell/hassell_extrisk_d0.pdf",height = 6,width=6)
plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(1.4,7.6),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025left,x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025right,x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(2,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_hassell}](./Results/hassell/hassell_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Hassell model : a = 0.5, b = 100, rc = 2.73) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_hassell}](./Results/hassell/hassell_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (hassell model with no dispersion : rc=2.73199); numlocs=5, numsteps=25, numsims=10000\label{fig_hassell_risk_d0}](./Results/hassell/hassell_extrisk_d0.pdf){ width=40%, height=40% }

#Maynard Smith Model :

```{r fig_msmith_scl_0.8, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"msmith"
scl<-0.8

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-4

rc<-b/(b-1)
rlist<-sort(c(seq(from=1.2,to=2.8,by=0.2),rc))

msmith_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(msmith_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    msmith_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    msmith_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(msmith_extrisk_d0,paste(resloc,"msmith_extrisk_d0.RDS",sep=""))

# plot for global dispersal in D matrix 
pdf(paste(resloc,"msmith_ext_risk_global_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

# Plot ext_risk_d0
msmith_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims
msmith_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_left_d0)/numsims

msmith_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims
msmith_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_right_d0)/numsims

pdf(paste(resloc,"msmith_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),xlim = c(1.2,2.8),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025left,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025right,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(1.5,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3, scl=0.8) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary_scl_0.8}](./Results/msmith_scl_0.8/msmith_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model : a = 1, b = 3, rc = 4/3, scl=0.8) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary_scl_0.8}](./Results/msmith_scl_0.8/msmith_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Maynard Smith model with no dispersion : rc=4/3, scl=0.8); numlocs=5, numsteps=25, numsims=10000\label{fig_msmith_risk_d0_scl_0.8}](./Results/msmith_scl_0.8/msmith_extrisk_d0.pdf){ width=40%, height=40% }

# Pennycuick model :

```{r get_rc_pennycuick,echo=F,cache=T,cache.extra=list(seed,mtime("1var_pop_model_bifurcation.R"))}
source("./1var_pop_model_bifurcation.R")
a_pennycuick<-0.1
b_pennycuick<-0.1
eps<-1e-10 #you can change it upto which decimal point you want it to be exact
rlist<-seq(from=4.3231657,to=4.3231658,by=eps)
res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r,a,b),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)

rc_pennycuick<-rlist[which.min(abs(res_pennycuick-0))]
formatC(rc_pennycuick,digits = 10, format="f") # accurate upto 10th decimal
```

```{r fig_pennycuick, echo=F,  results="hide", cache=T, cache.extra=list(seed,a_pennycuick,b_pennycuick,rc_pennycuick,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
model<-"pennycuick"

tempo<-paste("./Results/",model,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-a_pennycuick
b<-b_pennycuick
scl<-1

rlist<-sort(c(seq(from=2,to=7,by=0.5),rc_pennycuick))

pennycuick_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) # a dataframe to store ext risk at dispersal d=0 for all r
colnames(pennycuick_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"pennycuick_ext_risk_local_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    pennycuick_extrisk_d0$risk_left_d0[i]<-s$risk_left[1]
    pennycuick_extrisk_d0$risk_right_d0[i]<-s$risk_right[1]
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(pennycuick_extrisk_d0,paste(resloc,"pennycuick_extrisk_d0.RDS",sep=""))

# plot for global dispersal in D matrix 
pdf(paste(resloc,"pennycuick_ext_risk_global_disp.pdf",sep=""),height=9,width=12)
op<-par(mfrow=c(3,4),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    s<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s$d_seq,s$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s$d_seq,s$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()
```

```{r fig_pennycuick_extrisk_d0, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
pennycuick_extrisk_d0<-readRDS("./Results/pennycuick/pennycuick_extrisk_d0.RDS")

pennycuick_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_left_d0)/numsims
pennycuick_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_left_d0)/numsims

pennycuick_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_right_d0)/numsims
pennycuick_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_right_d0)/numsims

pdf("./Results/pennycuick/pennycuick_extrisk_d0.pdf",height = 6,width=6)
plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),
     xlim = c(2,7),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025left,x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_right_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025right,x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(3,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)

dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model : a = 0.1, b = 0.1) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_msmith_r_vary}](./Results/pennycuick/pennycuick_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model : a = 0.1, b = 0.1) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_msmith_r_vary}](./Results/pennycuick/pennycuick_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Pennycuick model with no dispersion : rc=4.3231657); numlocs=5, numsteps=25, numsims=10000\label{fig_pennycuick_risk_d0}](./Results/pennycuick/pennycuick_extrisk_d0.pdf){ width=40%, height=40% }


# Austin Brewer model :

```{r fig_abrewer_scl_0.8, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"austinbrewer"
scl<-0.8

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
s<-0.2
K<-50
p0<-K
rc<-1/(K*(1-exp(-s*K)))

rlist<-sort(c(0.002,0.004,0.006,0.008,0.01,0.015,rc,0.022,0.026))

abrewer_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(abrewer_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"abrewer_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,K,s)
    ext_thrs<-p0/10
    s0<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    abrewer_extrisk_d0$risk_left_d0[i]<-s0$risk_left[1]
    abrewer_extrisk_d0$risk_right_d0[i]<-s0$risk_right[1]
    plot(s0$d_seq,s0$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),
         xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s0$d_seq,s0$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(abrewer_extrisk_d0,paste(resloc,"abrewer_extrisk_d0.RDS",sep=""))

# plot for global dispersal in D matrix 
pdf(paste(resloc,"abrewer_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    params<-c(r,K,s)
    ext_thrs<-p0/10
    s0<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s0$d_seq,s0$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),
         xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s0$d_seq,s0$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

# Plot ext_risk_d0
abrewer_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_left_d0)/numsims
abrewer_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_left_d0)/numsims

abrewer_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_right_d0)/numsims
abrewer_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_right_d0)/numsims

pdf(paste(resloc,"abrewer_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(abrewer_extrisk_d0$r),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025left,x1=abrewer_extrisk_d0$r,
       y1=abrewer_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025right,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(0.005,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Austin Brewer model : K = 50, s = 0.2, rc = 0.02000091, scl=0.8) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_abrewer_r_vary_scl_0.8}](./Results/austinbrewer_scl_0.8/abrewer_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Austin Brewer model : K = 50, s = 0.2, rc = 0.02000091, scl=0.8) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_abrewer_r_vary_scl_0.8}](./Results/austinbrewer_scl_0.8/abrewer_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Austin Brewer model with no dispersion : rc=0.02000091, scl=0.8); numlocs=5, numsteps=25, numsims=10000\label{fig_abrewer_risk_d0_scl_0.8}](./Results/austinbrewer_scl_0.8/abrewer_extrisk_d0.pdf){ width=40%, height=40% }

# Verhulst model :

```{r fig_verhulst_scl_2.5, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)

model<-"verhulst"
scl<-2.5

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
p0<-1

rlist<-seq(from=0.2,to=1.8,by=0.2)

verhulst_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store ext risk at dispersal d=0 for all r
colnames(verhulst_extrisk_d0)<-c("r","risk_left_d0","risk_right_d0")


# plot for local dispersal in D matrix 
pdf(paste(resloc,"verhulst_ext_risk_local_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(i in c(1:length(rlist))){
    r<-rlist[i]
    ext_thrs<-p0/10
    s0<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=r,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=F,ploton = F)
    verhulst_extrisk_d0$risk_left_d0[i]<-s0$risk_left[1]
    verhulst_extrisk_d0$risk_right_d0[i]<-s0$risk_right[1]
    plot(s0$d_seq,s0$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),
         xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s0$d_seq,s0$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

saveRDS(verhulst_extrisk_d0,paste(resloc,"verhulst_extrisk_d0.RDS",sep=""))

# plot for global dispersal in D matrix 
pdf(paste(resloc,"verhulst_ext_risk_global_disp.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,1.2))
for(r in rlist){
    ext_thrs<-p0/10
    s0<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=r,ext_thrs=ext_thrs,
                 scl=scl,model=model,disp_everywhere=T,ploton = F)
    plot(s0$d_seq,s0$risk_left,xlim=c(0,1),ylim=c(0,1),type="b",col="red",panel.first = grid(),
         xlab="d",ylab="ext_risk",cex.lab=1.5,cex.axis=1.5)
    lines(s0$d_seq,s0$risk_right,type="b",col="blue")
    legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
    mtext(paste0("r = ", r))
}
par(op)
dev.off()

# Plot ext_risk_d0
verhulst_extrisk_d0$CI0.025left<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_left_d0)/numsims
verhulst_extrisk_d0$CI0.975left<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_left_d0)/numsims

verhulst_extrisk_d0$CI0.025right<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_right_d0)/numsims
verhulst_extrisk_d0$CI0.975right<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_right_d0)/numsims

pdf(paste(resloc,"verhulst_extrisk_d0.pdf",sep=""),height=6,width=6)
plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_left_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(verhulst_extrisk_d0$r),xlab="r",ylab="ext_risk",cex.lab=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025left,x1=verhulst_extrisk_d0$r,
       y1=verhulst_extrisk_d0$CI0.975left,angle=90,length=0.1,col="red",code=3)

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_right_d0,col="blue",type="b",pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025right,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975right,angle=90,length=0.1,col="blue",code=3)
mtext(paste0("d = 0 , numsims = ",numsims),side=3,line=0.2)
legend(0.5,1.08, c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), col=c('red', 'blue'), horiz=T, bty='n',cex=1.2)
dev.off()
```

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Verhulst model : rc = 1, scl=2.5) with local dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_local_disp_verhulst_r_vary_scl_2.5}](./Results/verhulst_scl_2.5/verhulst_ext_risk_local_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Verhulst model : rc = 1, scl=2.5) with global dispersion; numlocs=5, numsteps=25, numsims=10000\label{fig_risk_global_disp_verhulst_r_vary_scl_2.5}](./Results/verhulst_scl_2.5/verhulst_ext_risk_global_disp.pdf){ width=40%, height=40% }

![Effect of non-Normal environmental noise copula on extinction risk after 25 years (Verhulst model with no dispersion : rc = 1, scl=2.5); numlocs=5, numsteps=25, numsims=10000\label{fig_verhulst_risk_d0_scl_2.5}](./Results/verhulst_scl_2.5/verhulst_extrisk_d0.pdf){ width=40%, height=40% }




















