---
title: "Supporting information: Tail associations and their impact on extinction risk"
author: "Shyamolina Ghosh, Daniel Reuman"
date: "`r format(Sys.time(), '%d %B, %Y')`"
geometry: "left=1in,right=1in,top=1in,bottom=1in"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: head_suppmat.sty
      
tables: True
link-citations: True
urlcolor : blue
indent : True

csl: TheAmericanNaturalist.csl
bibliography: Ref_extrisk.bib
---

\pagenumbering{roman}
\tableofcontents
\listoffigures

\pagebreak
\pagenumbering{arabic}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
library(abind)
source("mtime.R")
```

```{r get_srho_common, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("ExtremeTailDep.R"))}
set.seed(seed)
library(copula)
source("./ExtremeTailDep.R")

np<-1000000
srho_common<-0.875 #7/8

xtc_r<-retd(n=np,d=2,rl=1,mn=0,sdev=1) # copula with extreme right tail

saveRDS(srho_common,"./Results/srho_common.RDS") 
  
# flip xtc_r to get xtc_l
#xtc_l<-1-xtc_r

# make marginals uniform 
xtc_r<-pnorm(xtc_r)
xtc_l<-1-xtc_r
  
# for clayton : left tail dep.
copC<-claytonCopula(3)
parC<-iRho(copC,rho=srho_common)
  
# first generate Clayton copula 
cc<-claytonCopula(par=parC,dim=2)
mtc_l<-rCopula(np,cc)  
  
# flip Clayton copula 
mtc_r<-1-mtc_l

# calculate rho with sampling variation
scor_el<-cor(xtc_l,xtc_l,method = "spearman")
scor_el<-scor_el[1,2]

scor_er<-cor(xtc_r,xtc_r,method = "spearman")
scor_er<- scor_er[1,2] 

scor_ml<-cor(mtc_l,mtc_l,method = "spearman")
scor_ml<- scor_ml[1,2]

scor_mr<-cor(mtc_r,mtc_r,method ="spearman")
scor_mr<- scor_mr[1,2] 
```


```{r plot_intro_fig, echo=F, results="hide"}

#--------- Plot for intro + methods ------------------------------------

# for plotting purpose I just showed only first 500 points

pdf("./Results/introfig_copula.pdf", height=3, width=12)
op<-par(mfrow=c(1,4),mar=c(6,6,2,2),mgp=c(3,1,0))

# extreme left tail
plot(xtc_l[1:500,1],xtc_l[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
#legend(x="topleft",legend="A",bty="n",cex=2.5)
text(x=0.1,y=0.9,"A",cex=2.5)
text(x=0.8,y=0.1,round(scor_el,4),cex=2)

# moderate left tail
plot(mtc_l[1:500,1],mtc_l[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
text(x=0.1,y=0.9,"B",cex=2.5)
text(x=0.8,y=0.1,round(scor_ml,4),cex=2)

# moderate right tail
plot(mtc_r[1:500,1],mtc_r[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
text(x=0.1,y=0.9,"C",cex=2.5)
text(x=0.8,y=0.1,round(scor_mr,4),cex=2)

# extreme right tail
plot(xtc_r[1:500,1],xtc_r[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
text(x=0.1,y=0.9,"D",cex=2.5)
text(x=0.8,y=0.1,round(scor_er,4),cex=2)

par(op)
dev.off()


#========== Schematic fig for partial spearman correlation ==============
pdf("./Results/PartialSpearmanFig.pdf", width=6, height=6)
op<-par(mar=c(6,6,2,2),mgp=c(3,1,0))
plot(mtc_r[1:150,1],mtc_r[1:150,2],type='p',pch=19,col=rgb(0,0,0,0.15),cex=1.5,
     cex.axis=2,cex.lab=2.5,xlab="u",ylab="v")
lines(c(0,0.3),c(0.3,0),type='l')
lines(c(0,0.6),c(0.6,0),type='l')
lines(c(0,1.4),c(1.4,0),type='l')
lines(c(0,1.7),c(1.7,0),type='l')
par(op)
dev.off()
```

```{r sim_linear_mtd, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("ext_risk_cop_age_str.R"))}
# extinction risk with moderate tail dep. for single patch linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")

numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-Inf
srho<-srho_common  # Spearman's rho

# for clayton
copC<-claytonCopula(3)
parC<-iRho(copC,rho=srho)
par<-parC
fam<-3

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

C_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(C_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
#---------------------------------------------------------------------------------

# Now for survival clayton : should be the same parameter as of clayton if Spearman's rho is the same 

fam<-13
par<-parC

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

SC_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(SC_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
```

```{r fig_agestr_mtd_linear, echo=F,results="hide"}
xL<-C_age$extdf
xR<-SC_age$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_C_SC_linear.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("moderate LT","moderate RT", expression(paste(Omega,"= ", infinity))), lty=c(1,1, NA),  
       col=c('red', 'blue', NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_nonlinear_mtd, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("ext_risk_cop_age_str.R"))}
# extinction risk with moderate tail dep. for single patch non-linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")

numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-100
srho<-srho_common  # Spearman's rho

# for clayton
copC<-claytonCopula(3)
parC<-iRho(copC,rho=srho)
par<-parC
fam<-3

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_nonlinear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

C_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(C_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
#---------------------------------------------------------------------------------

# Now for survival clayton : should be the same parameter as of clayton if Spearman's rho is the same 

fam<-13
par<-parC

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

SC_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(SC_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
```

```{r fig_agestr_mtd_nonlinear, echo=F,results="hide"}
xL<-C_age$extdf
xR<-SC_age$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_C_SC_nonlinear_omg_",omg,".pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("moderate LT","moderate RT", as.expression(bquote(Omega==.(omg)))), lty=c(1,1,NA),  
       col=c('red', 'blue',NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_agestr_with_extremetail_linear, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("ext_risk_cop_age_str.R"),mtime("ExtremeTailDep.R"))}
# extinction risk with extreme tail dep. for single patch linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")
source("ExtremeTailDep.R")
numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-Inf

# For extreme right tail dep.
mr<-retd(n = (numsteps*numsims),d = 2,rl =1,mn=0,sdev=1)
cop<-pnorm(mr) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_right_taildep_linear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_right_tail_cop.pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
las_exR<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(las_exR,paste(resloc,"sim_age_str_extreme_right_taildep.RDS",sep=""))

# For extreme left tail dep.
ml<-retd(n = (numsteps*numsims),d = 2,rl =-1,mn=0,sdev=1)
cop<-pnorm(ml) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_left_taildep_linear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_left_tail_cop.pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
 las_exL<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(las_exL,paste(resloc,"sim_age_str_extreme_left_taildep.RDS",sep=""))
```

```{r fig_agestr_with_extremetail_linear, echo=F,results="hide"}
xL<-las_exL$extdf
xR<-las_exR$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_extremetail_linear.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("extreme LT","extreme RT", expression(paste(Omega,"= ", infinity))), lty=c(1,1, NA),  
       col=c('red', 'blue', NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_agestr_with_extremetail_nonlinear, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("ext_risk_cop_age_str.R"),mtime("ExtremeTailDep.R"))}
# extinction risk with extreme tail dep. for single patch non-linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")
source("ExtremeTailDep.R")
numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-100
# For extreme right tail dep.
mr<-retd(n = (numsteps*numsims),d = 2,rl =1,mn=0,sdev=1)
cop<-pnorm(mr) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_right_taildep_nonlinear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_right_tail_cop_omg_",omg,".pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
nlas_exR<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(nlas_exR,paste(resloc,"sim_age_str_extreme_right_taildep.RDS",sep=""))
 # For extreme left tail dep.
ml<-retd(n = (numsteps*numsims),d = 2,rl =-1,mn=0,sdev=1)
cop<-pnorm(ml) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_left_taildep_nonlinear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_right_tail_cop_omg_",omg,".pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
nlas_exL<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(nlas_exL,paste(resloc,"sim_age_str_extreme_left_taildep.RDS",sep=""))
```

```{r fig_agestr_with_extremetail_nonlinear, echo=F,results="hide"}
xL<-nlas_exL$extdf
xR<-nlas_exR$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_extremetail_nonlinear_omg_",omg,".pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("extreme LT","extreme RT", as.expression(bquote(Omega==.(omg)))), lty=c(1,1,NA),  
       col=c('red', 'blue',NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_ricker_scl_1, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

rc_ricker<-1 # transition from under to overcompensatory dynamics
r_bf_ricker<-2 # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=0,max=r_bf_ricker)
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_ricker)
q2<-abs(unname(qr1[2])-rc_ricker)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Ricker model !!!",immediate.=T,call.=T)
}

numsims<-10000
numsteps<-25
numlocs<-5
K<-50
scl<-1
srho<-srho_common
ext_thrs<-K/10
model<-"ricker"

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

#initiate a dataframe to store ext risk at dispersal d=0 for all r
ricker_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                              NA*numeric(length(rlist)),NA*numeric(length(rlist))) 
colnames(ricker_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

res_ricker_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,K)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_ricker_local<-abind(res_ricker_local,temp_mat,along = 3)
      
    ricker_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    ricker_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    ricker_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    ricker_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_ricker_local)<-list(NULL,cnm,anm)

saveRDS(ricker_extrisk_d0,paste(resloc,"ricker_extrisk_d0.RDS",sep=""))
saveRDS(res_ricker_local,paste(resloc,"res_ricker_local.RDS",sep=""))

# For global dispersion
res_ricker_global<-c()

for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,K)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_ricker_global<-abind(res_ricker_global,temp_mat,along = 3)
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_ricker_global)<-list(NULL,cnm,anm)
saveRDS(res_ricker_global,paste(resloc,"res_ricker_global.RDS",sep=""))
```

```{r fig_ricker_scl_1, echo=F, results="hide",cache=T, cache.extra=list(seed,res_ricker_local,res_ricker_global)}

pdf("./Results/common_legend_extreme_noise.pdf",height=1,width=12)
op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("center", c("noise: extreme LTdep.","noise: extreme RTdep."), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'),x.intersp = 0.2,
         cex = 2.5, xpd = TRUE, horiz = T, inset = c(0,0), 
         bty = "n")
par(op)
dev.off()

pdf("./Results/common_legend_moderate_noise.pdf",height=1,width=12)
op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("center", c("noise: moderate LTdep.","noise: moderate RTdep."), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'),x.intersp = 0.2,
         cex = 2.5, xpd = TRUE, horiz = T, inset = c(0,0), 
         bty = "n")
par(op)
dev.off()

pdf("./Results/common_legend_extreme_and_moderate_noise.pdf",height=1,width=12)
op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("center", c("extreme LT,","moderate LT,", "moderate RT,","extreme RT"), lty=c(1,1), pch=c(1,1,1,1), 
         col=c('red', 'orange','skyblue','blue'),x.intersp = 0.1,
         cex = 2.2, xpd = TRUE, horiz = T, inset = c(0,0), 
         bty = "n")
par(op)
dev.off()

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_ext_risk_local_disp_extremenoise.pdf",sep=""),height=9,width=9)
#op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_local)[3]){
  #s<-res_ricker_local[,,i]
  ss<-res_ricker_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"ricker_ext_risk_global_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_global)[3]){
  #ss<-res_ricker_global
  ss<-res_ricker_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"ricker_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=9,width=9)

op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_local)[3]){
  #s<-res_ricker_local[,,i]
  ss<-res_ricker_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"ricker_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_global)[3]){
  #ss<-res_ricker_global
  ss<-res_ricker_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#----------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
#op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_local)[3]){
  #s<-res_ricker_local[,,i]
  ss<-res_ricker_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"ricker_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_global)[3]){
  #ss<-res_ricker_global
  ss<-res_ricker_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_ricker_extrisk_d0_scl_1, echo=F,results="hide"}
set.seed(seed)

ricker_extrisk_d0<-readRDS(paste(resloc,"ricker_extrisk_d0.RDS",sep=""))
numsims<-10000
ricker_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_xleft_d0)/numsims
ricker_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_xleft_d0)/numsims

ricker_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_xright_d0)/numsims
ricker_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_xright_d0)/numsims

ricker_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_mleft_d0)/numsims
ricker_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_mleft_d0)/numsims

ricker_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_mright_d0)/numsims
ricker_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_mright_d0)/numsims

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xleft_d0,col="red",type="b",
     ylim=c(0,1),xlim = range(ricker_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xleft,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975xleft,
       angle=90,length=0.1,col="red",code=3)
abline(v=rc_ricker,lty="dotted",col="black") #rc=1

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xright,x1=ricker_extrisk_d0$r,
       y1=ricker_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Ricker"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.95, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", legend=c("Ricker",paste0("K = ",K)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mleft_d0,col="red",type="b",
     ylim=c(0,1),xlim = range(ricker_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mleft,x1=ricker_extrisk_d0$r,
       y1=ricker_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_ricker,lty="dotted",col="black") #rc=1

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mright,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Ricker"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.95, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", legend=c("Ricker",paste0("K = ",K)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xleft_d0,col="red",type="b",
     ylim=c(0,1),xlim = range(ricker_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xleft,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975xleft,
       angle=90,length=0.1,col="red",code=3)
abline(v=rc_ricker,lty="dotted",col="black") #rc=1

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mleft,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mright,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xright,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Ricker"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.95, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r sim_hassell_scl_1, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"hassell"

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-100
scl<-1
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

rc_hassell<-((b/(b-1)))^b # transition from under to overcompensatory dynamics
r_bf_hassell<- ((b/(b-2)))^b # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=1,max=r_bf_hassell) # r must be > 1
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_hassell)
q2<-abs(unname(qr1[2])-rc_hassell)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Hassell model !!!",immediate.=T,call.=T)
}

hassell_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                               NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                       # ext risk at dispersal d=0 for all r
colnames(hassell_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

res_hassell_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_hassell_local<-abind(res_hassell_local,temp_mat,along = 3)
      
    hassell_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    hassell_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    hassell_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    hassell_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_hassell_local)<-list(NULL,cnm,anm)

saveRDS(hassell_extrisk_d0,paste(resloc,"hassell_extrisk_d0.RDS",sep=""))
saveRDS(res_hassell_local,paste(resloc,"res_hassell_local.RDS",sep=""))

# For global dispersion
res_hassell_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_hassell_global<-abind(res_hassell_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_hassell_global)<-list(NULL,cnm,anm)
saveRDS(res_hassell_global,paste(resloc,"res_hassell_global.RDS",sep=""))
```

```{r fig_hassell_scl_1, echo=F, results="hide",cache=T, cache.extra=list(seed,res_hassell_local,res_hassell_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"hassell_ext_risk_local_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_local)[3]){
  ss<-res_hassell_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"hassell_ext_risk_global_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_global)[3]){
  ss<-res_hassell_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"hassell_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_local)[3]){
  ss<-res_hassell_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"hassell_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_global)[3]){
  ss<-res_hassell_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#----------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"hassell_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_local)[3]){
  ss<-res_hassell_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"hassell_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_global)[3]){
  ss<-res_hassell_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_hassell_extrisk_d0_scl_1, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
hassell_extrisk_d0<-readRDS(paste(resloc,"hassell_extrisk_d0.RDS",sep=""))

hassell_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_xleft_d0)/numsims
hassell_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_xleft_d0)/numsims

hassell_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_xright_d0)/numsims
hassell_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_xright_d0)/numsims

hassell_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_mleft_d0)/numsims
hassell_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_mleft_d0)/numsims

hassell_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_mright_d0)/numsims
hassell_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"hassell_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(hassell_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_hassell,lty="dotted",col="black")

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xright,x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Hassell"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Hassell",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"hassell_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(hassell_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_hassell,lty="dotted",col="black")

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mright,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Hassell"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Hassell",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"hassell_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(hassell_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_hassell,lty="dotted",col="black")

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mright,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xright,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Hassell"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```


```{r sim_msmith_scl_0.8, echo=F, cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"msmith"
scl<-0.8
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-4

rc_msmith<-b/(b-1)
r_bf_msmith<-b/(b-2) # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=1,max=r_bf_msmith) #r must be > 1 for +ve eqm pt.
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_msmith)
q2<-abs(unname(qr1[2])-rc_msmith)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Maynard-smith model !!!",immediate.=T,call.=T)
}

msmith_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                              NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                                     # ext risk at dispersal d=0 for all r
colnames(msmith_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_msmith_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_msmith_local<-abind(res_msmith_local,temp_mat,along = 3)
      
    msmith_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    msmith_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    msmith_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    msmith_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_msmith_local)<-list(NULL,cnm,anm)

saveRDS(msmith_extrisk_d0,paste(resloc,"msmith_extrisk_d0.RDS",sep=""))
saveRDS(res_msmith_local,paste(resloc,"res_msmith_local.RDS",sep=""))

# For global dispersal in D matrix 
res_msmith_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_msmith_global<-abind(res_msmith_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_msmith_global)<-list(NULL,cnm,anm)
saveRDS(res_msmith_global,paste(resloc,"res_msmith_global.RDS",sep=""))
```

```{r fig_msmith_scl_0.8, echo=F, results="hide",cache=T, cache.extra=list(seed,res_msmith_local,res_msmith_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"msmith_ext_risk_local_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_msmith_local)[3]){
  ss<-res_msmith_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"msmith_ext_risk_global_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5))

for(i in 1:dim(res_msmith_global)[3]){
  ss<-res_msmith_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"msmith_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_msmith_local)[3]){
  ss<-res_msmith_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"msmith_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5))

for(i in 1:dim(res_msmith_global)[3]){
  ss<-res_msmith_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#---------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"msmith_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_msmith_local)[3]){
  ss<-res_msmith_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"msmith_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5))

for(i in 1:dim(res_msmith_global)[3]){
  ss<-res_msmith_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_msmith_extrisk_d0_scl_0.8, echo=F,results="hide"}
set.seed(seed)

msmith_extrisk_d0<-readRDS(paste(resloc,"msmith_extrisk_d0.RDS",sep=""))
numsims<-10000
msmith_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_xleft_d0)/numsims
msmith_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_xleft_d0)/numsims

msmith_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_xright_d0)/numsims
msmith_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_xright_d0)/numsims

msmith_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_mleft_d0)/numsims
msmith_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_mleft_d0)/numsims

msmith_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_mright_d0)/numsims
msmith_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"msmith_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(msmith_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_msmith,lty="dotted",col="black")

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xright_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xright,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Maynard Smith"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"msmith_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(msmith_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_msmith,lty="dotted",col="black")

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mright_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mright,x1=msmith_extrisk_d0$r,
       y1=msmith_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Maynard Smith"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"msmith_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(msmith_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_msmith,lty="dotted",col="black")

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mright,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xright,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Maynard Smith"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r get_rc_pennycuick,echo=F,results="hide",cache=T,cache.extra=list(seed,mtime("bifurcation_pennycuick.R"))}
set.seed(seed)
source("./bifurcation_pennycuick.R")
a_pennycuick<-0.1
b_pennycuick<-0.1
eps<-1e-10 #you can change it upto which decimal point you want it to be exact
rlist<-seq(from=4.3231657,to=4.3231659,by=eps)
res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r,a_pennycuick,b_pennycuick),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)

rc_pennycuick<-rlist[which.min(abs(res_pennycuick-0))]
formatC(rc_pennycuick,digits = 10, format="f") # accurate upto 10th decimal

# This is to find the critical r value where stable to unstable eqm occurs
rlist<-seq(from=9.4672389,to=9.46724,by=eps)
#formatC(rlist,digits = 14, format="f") 

res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r=r,a_pennycuick,b_pennycuick),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)
#fp<-0
fp<--1
r_bf_pennycuick<-rlist[which.min(abs(res_pennycuick-fp))]
#formatC(rc_pen_uns,digits = 14, format="f") 
```

```{r sim_pennycuick_scl_1, echo=F, cache=T, cache.extra=list(seed,srho_common,a_pennycuick,b_pennycuick,rc_pennycuick,r_bf_pennycuick,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"pennycuick"
scl<-1
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-a_pennycuick
b<-b_pennycuick

rng1<-runif(10000,min=(1+exp(-a)),max=r_bf_pennycuick) # for +ve eqm pt.
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_pennycuick)
q2<-abs(unname(qr1[2])-rc_pennycuick)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)
if(vxx>1e-10){
  warning("Not equal spacing in rlist : Pennycuick model !!!",immediate.=T,call.=T)
}

pennycuick_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                                  NA*numeric(length(rlist)),NA*numeric(length(rlist))) # a dataframe to store 
                                                                            # ext risk at dispersal d=0 for all r
colnames(pennycuick_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_pennycuick_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_pennycuick_local<-abind(res_pennycuick_local,temp_mat,along = 3)
      
    pennycuick_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    pennycuick_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    pennycuick_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    pennycuick_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_pennycuick_local)<-list(NULL,cnm,anm)

saveRDS(pennycuick_extrisk_d0,paste(resloc,"pennycuick_extrisk_d0.RDS",sep=""))
saveRDS(res_pennycuick_local,paste(resloc,"res_pennycuick_local.RDS",sep=""))

# For global dispersal in D matrix 
res_pennycuick_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_pennycuick_global<-abind(res_pennycuick_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_pennycuick_global)<-list(NULL,cnm,anm)
saveRDS(res_pennycuick_global,paste(resloc,"res_pennycuick_global.RDS",sep=""))
```

```{r fig_pennycuick_scl_1, echo=F, results="hide",cache=T, cache.extra=list(seed,res_pennycuick_local,res_pennycuick_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"pennycuick_ext_risk_local_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.2,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_local)[3]){
  ss<-res_pennycuick_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
   mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"pennycuick_ext_risk_global_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_global)[3]){
  ss<-res_pennycuick_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"pennycuick_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.2,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_local)[3]){
  ss<-res_pennycuick_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
   mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"pennycuick_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_global)[3]){
  ss<-res_pennycuick_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#--------------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"pennycuick_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.2,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_local)[3]){
  ss<-res_pennycuick_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"pennycuick_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_global)[3]){
  ss<-res_pennycuick_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_pennycuick_extrisk_d0_scl_1, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
pennycuick_extrisk_d0<-readRDS(paste(resloc,"pennycuick_extrisk_d0.RDS",sep=""))

pennycuick_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_xleft_d0)/numsims
pennycuick_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_xleft_d0)/numsims

pennycuick_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_xright_d0)/numsims
pennycuick_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_xright_d0)/numsims

pennycuick_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_mleft_d0)/numsims
pennycuick_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_mleft_d0)/numsims

pennycuick_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_mright_d0)/numsims
pennycuick_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"pennycuick_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(pennycuick_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_pennycuick,lty="dotted",col="black")

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xright,x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Pennycuick"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Pennycuick",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"pennycuick_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(pennycuick_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_pennycuick,lty="dotted",col="black")

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mright,x1=pennycuick_extrisk_d0$r,
       y1=pennycuick_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Pennycuick"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Pennycuick",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"pennycuick_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(pennycuick_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_pennycuick,lty="dotted",col="black")

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mright,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xright,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Pennycuick"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r sim_verhulst_scl_0.6, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"verhulst"
scl<-0.6
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
K<-1
p0<-K
ext_thrs<-p0/10
    
rc_verhulst<-1 # transition from under to overcompensatory dynamics
r_bf_verhulst<-2 # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=0,max=r_bf_verhulst)
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_verhulst)
q2<-abs(unname(qr1[2])-rc_verhulst)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Verhulst model !!!",immediate.=T,call.=T)
}

verhulst_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                                NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                   # ext risk at dispersal d=0 for all r
colnames(verhulst_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_verhulst_local<-c()

for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,K)
    
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_verhulst_local<-abind(res_verhulst_local,temp_mat,along = 3)
      
    verhulst_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    verhulst_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    verhulst_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    verhulst_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_verhulst_local)<-list(NULL,cnm,anm)

saveRDS(verhulst_extrisk_d0,paste(resloc,"verhulst_extrisk_d0.RDS",sep=""))
saveRDS(res_verhulst_local,paste(resloc,"res_verhulst_local.RDS",sep=""))

# For global dispersal in D matrix 
res_verhulst_global<-c()
for(r in rlist){
    params<-c(r,K)
    
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_verhulst_global<-abind(res_verhulst_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_verhulst_global)<-list(NULL,cnm,anm)
saveRDS(res_verhulst_global,paste(resloc,"res_verhulst_global.RDS",sep=""))
```

```{r fig_verhulst_scl_0.6, echo=F, results="hide",cache=T, cache.extra=list(seed,res_verhulst_local,res_verhulst_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"verhulst_ext_risk_local_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_local)[3]){
  ss<-res_verhulst_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"verhulst_ext_risk_global_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_global)[3]){
  ss<-res_verhulst_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"verhulst_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_local)[3]){
  ss<-res_verhulst_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"verhulst_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_global)[3]){
  ss<-res_verhulst_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#------------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"verhulst_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_local)[3]){
  ss<-res_verhulst_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"verhulst_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_global)[3]){
  ss<-res_verhulst_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_verhulst_extrisk_d0_scl_0.6, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
verhulst_extrisk_d0<-readRDS(paste(resloc,"verhulst_extrisk_d0.RDS",sep=""))

verhulst_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_xleft_d0)/numsims
verhulst_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_xleft_d0)/numsims

verhulst_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_xright_d0)/numsims
verhulst_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_xright_d0)/numsims

verhulst_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_mleft_d0)/numsims
verhulst_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_mleft_d0)/numsims

verhulst_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_mright_d0)/numsims
verhulst_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"verhulst_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(verhulst_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xleft,x1=verhulst_extrisk_d0$r,
       y1=verhulst_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_verhulst,lty="dotted",col="black")

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xright_d0,col="blue",type="b",pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Verhulst"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Verhulst",paste0("K =1, sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"verhulst_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(verhulst_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mleft,x1=verhulst_extrisk_d0$r,
       y1=verhulst_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_verhulst,lty="dotted",col="black")

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mright_d0,col="blue",type="b",pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Verhulst"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Verhulst",paste0("K =1, sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"verhulst_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(verhulst_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xleft,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_verhulst,lty="dotted",col="black")

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mleft,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Verhulst"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r sim_abrewer_scl_0.6, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"austinbrewer"
scl<-0.6
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
s<-0.2
K<-50

rc_abrewer<-1/(K*(1-exp(-s*K))) # transition from under to overcompensatory dynamics
r_bf_abrewer<-2*rc_abrewer # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=0,max=r_bf_abrewer)
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_abrewer)
q2<-abs(unname(qr1[2])-rc_abrewer)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Austin-Brewer model !!!",immediate.=T,call.=T)
}

abrewer_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                               NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                         # ext risk at dispersal d=0 for all r
colnames(abrewer_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_abrewer_local<-c()

for(i in c(1:length(rlist))){
  r<- rlist[i]
  p0<-K
  params<-c(r,K,s)
  ext_thrs<-p0/10
  
  ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
               scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
  
  temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
  res_abrewer_local<-abind(res_abrewer_local,temp_mat,along = 3)
  
  abrewer_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
  abrewer_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
  
  abrewer_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
  abrewer_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_abrewer_local)<-list(NULL,cnm,anm)

saveRDS(abrewer_extrisk_d0,paste(resloc,"abrewer_extrisk_d0.RDS",sep=""))
saveRDS(res_abrewer_local,paste(resloc,"res_abrewer_local.RDS",sep=""))

# For global dispersal in D matrix 
res_abrewer_global<-c()
for(r in rlist){
  p0<-K
  params<-c(r,K,s)
  ext_thrs<-p0/10
  
  ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
               scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
  
  temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
  res_abrewer_global<-abind(res_abrewer_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_abrewer_global)<-list(NULL,cnm,anm)
saveRDS(res_abrewer_global,paste(resloc,"res_abrewer_global.RDS",sep=""))
```

```{r fig_abrewer_scl_0.6, echo=F, results="hide",cache=T, cache.extra=list(seed,res_abrewer_local,res_abrewer_global)}
#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"abrewer_ext_risk_local_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_local)[3]){
  ss<-res_abrewer_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"abrewer_ext_risk_global_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_global)[3]){
  ss<-res_abrewer_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"abrewer_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_local)[3]){
  ss<-res_abrewer_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"abrewer_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_global)[3]){
  ss<-res_abrewer_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#--------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"abrewer_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_local)[3]){
  ss<-res_abrewer_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"abrewer_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_global)[3]){
  ss<-res_abrewer_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_abrewer_extrisk_d0_scl_0.6, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
abrewer_extrisk_d0<-readRDS(paste(resloc,"abrewer_extrisk_d0.RDS",sep=""))

abrewer_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_xleft_d0)/numsims
abrewer_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_xleft_d0)/numsims
abrewer_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_xright_d0)/numsims
abrewer_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_xright_d0)/numsims

abrewer_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_mleft_d0)/numsims
abrewer_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_mleft_d0)/numsims
abrewer_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_mright_d0)/numsims
abrewer_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"abrewer_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(abrewer_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xleft,x1=abrewer_extrisk_d0$r,
       y1=abrewer_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_abrewer,lty="dotted",col="black")

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xright_d0,col="blue",type="b",pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Austin-Brewer"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("s = ",s,", K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Austin-Brewer",paste0("s = ",s," , K = ",K),paste0(" sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"abrewer_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(abrewer_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mleft,x1=abrewer_extrisk_d0$r,
       y1=abrewer_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_abrewer,lty="dotted",col="black")

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mright_d0,col="blue",type="b",pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Austin-Brewer"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("s = ",s,", K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Austin-Brewer",paste0("s = ",s," , K = ",K),paste0(" sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"abrewer_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(abrewer_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xleft,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_abrewer,lty="dotted",col="black")

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mleft,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Austin-Brewer"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("s = ",s,", K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r create_maintext_fig_localdisp_summary,echo=F,results="hide"}

getplot<-function(x,rlist,noisetype){
  lasta<-dim(x)[3]
Af<-as.data.frame(x[,,1][1:6,])
Al<-as.data.frame(x[,,lasta][1:6,])

if(noisetype=="both"){
   plot(Af$d,Af$risk_xleft,xlim=range(Af$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
   lines(Af$d,Af$risk_mleft,type="b",col="orange")
   lines(Af$d,Af$risk_mright,type="b",col="skyblue")
   lines(Af$d,Af$risk_xright,type="b",col="blue")

  mtext(paste0("r = ", round(rlist[1],5)))

  plot(Al$d,Al$risk_xleft,xlim=range(Al$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
   lines(Al$d,Al$risk_mleft,type="b",col="orange")
   lines(Al$d,Al$risk_mright,type="b",col="skyblue")
   lines(Al$d,Al$risk_xright,type="b",col="blue")
   
  mtext(paste0("r = ", round(rlist[lasta],5)))
  
 }else if(noisetype=="extreme"){
  risk_left1<-Af$risk_xleft
  risk_right1<-Af$risk_xright
  
  risk_left2<-Al$risk_xleft
  risk_right2<-Al$risk_xright
  
  plot(Af$d,risk_left1,xlim=range(Af$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
   lines(Af$d,risk_right1,type="b",col="blue")

  mtext(paste0("r = ", round(rlist[1],5)))

  plot(Al$d,risk_left2,xlim=range(Al$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(Al$d,risk_right2,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[lasta],5)))
  
 }else if(noisetype=="moderate"){
  risk_left1<-Af$risk_mleft
  risk_right1<-Af$risk_mright
  
  risk_left2<-Al$risk_mleft
  risk_right2<-Al$risk_mright
  
  plot(Af$d,risk_left1,xlim=range(Af$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(Af$d,risk_right1,type="b",col="blue")

  mtext(paste0("r = ", round(rlist[1],5)))

  plot(Al$d,risk_left2,xlim=range(Al$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(Al$d,risk_right2,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[lasta],5)))
  
 }else{
  cat("specify noisetype argument!")
  }
}
#------------- for extreme tail dep. noise : local dispersal ---------------------
pdf("./Results/allmodel_ext_risk_local_disp_extremenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_local
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: extreme LTdep.","noise: extreme RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
#mtext(paste("(K = 50, sd = 1)"), side = 3, line=-8.2, adj=0.6, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist,noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_local
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_local
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_local
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_local
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_local
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist,noisetype = "extreme")

par(op)
dev.off()

#------------- for moderate tail dep. noise : local dispersal ---------------------
pdf("./Results/allmodel_ext_risk_local_disp_moderatenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_local
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: moderate LTdep.","noise: moderate RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
#mtext(paste("(K = 50, sd = 1)"), side = 3, line=-8.2, adj=0.6, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist,noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_local
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_local
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_local
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_local
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_local
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist,noisetype = "moderate")

par(op)
dev.off()

#------------- for extreme and moderate tail dep. noise : local dispersal summary fig. -------------------
pdf("./Results/allmodel_ext_risk_local_disp_extreme_and_moderate_noise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_local
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend(x=0.6,y=1.3, c("extreme LT","moderate LT","moderate RT","extreme RT"), lty=c(1,1,1,1), pch=c(1,1,1.1), 
       col=c('red', 'orange','skyblue','blue'), horiz=F, bty='n', cex=1.6, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-9, adj=0.3, cex=1, col="black")
#mtext(paste("(K = 50, sd = 1)"), side = 3, line=-8.2, adj=0.6, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-11, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist,noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_local
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_local
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_local
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_local
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_local
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist,noisetype = "both")

par(op)
dev.off()
```
 
```{r create_maintext_fig_globaldisp_summary,echo=F,results="hide"}

#------------- for extreme tail dep. noise ---------------------

pdf("./Results/allmodel_ext_risk_global_disp_extremenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_global
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: extreme LTdep.","noise: extreme RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0,x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_global
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_global
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_global
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_global
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_global
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

par(op)
dev.off()

#--------------------for moderate tail dep. noise -----------------------

pdf("./Results/allmodel_ext_risk_global_disp_moderatenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_global
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: moderate LTdep.","noise: moderate RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_global
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_global
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_global
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_global
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_global
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

par(op)
dev.off()

#--------------------for extreme and moderate tail dep. noise : global dispersal summary fig-----------------------

pdf("./Results/allmodel_ext_risk_global_disp_extreme_and_moderate_noise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_global
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend(x=0.6,y=1.3, c("extreme LT","moderate LT","moderate RT","extreme RT"), lty=c(1,1,1,1), pch=c(1,1,1.1), 
       col=c('red', 'orange','skyblue','blue'), horiz=F, bty='n', cex=1.6, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-9, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-11, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_global
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_global
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_global
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_global
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_global
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

par(op)
dev.off()
``` 

```{r make_tab_model_summary,echo=F}
library(tibble)

dt1 <- tibble("Models"= c("Ricker",
           "Hassell",
           "Maynard Smith",
           "Pennycuick",
           "Verhulst",
           "Austin-Brewer")
)

dt2<-tibble("$\\lambda_i(t)$" = c("$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} \\exp[r (1-P_i(t)/K)$]",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} r/(1+aP_i(t))^b$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} r/[1+(aP_i(t))^b]$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} r/[1+\\exp \\{-a(1-P_i(t)/b)\\}]$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} [1+r(1-P_i(t)/K)]$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} [1+r(K-P_i(t))\\{1-\\exp(-sP_i(t))\\}]$"
))

dt3<-tibble("\\hspace{-0.1 cm} Parameters used" = c("K = 50, $\\sigma$ = 1",
                            "a = 0.5, b = 100, $\\sigma$ = 1",
                            "a = 0.5, b = 4, $\\sigma$ = 0.8",
                           "a = 0.1, b= 0.1, $\\sigma$ = 1",
                           "K = 1, $\\sigma$ = 0.6",
                           "s = 0.2, K = 50, $\\sigma$ = 0.6"
))

dt4<-tibble("$P_{e}$" = c("K",
                        "$(r^{1/b}-1)/a$",
                        "$[(r-1)^{1/b}]/a$",
                        "$[b\\{a+ln(r-1)\\}]/a$",
                        "K",
                        "K"
))

dt4_2<-tibble("$r_{min}$" = c("0",
                        "1",
                        "1",
                        "$1+\\exp(-a)$",
                        "0",
                        "0"
))

dt5<-tibble("$r_{c}$" = c(rc_ricker,
                        rc_hassell,
                        rc_msmith,
                        rc_pennycuick,
                        rc_verhulst,
                        rc_abrewer
))

dt6<-tibble("$r_{bf}$" = c(r_bf_ricker,
                           r_bf_hassell,
                           r_bf_msmith,
                           r_bf_pennycuick,
                           r_bf_verhulst,
                           r_bf_abrewer
))

dt<-cbind(dt1,dt2,dt3,dt4,dt4_2,dt5,dt6)
saveRDS(dt,"./Results/tab_model_summary.RDS")
```


<!--FIG:  age structure model results for moderate tail dep. (C, SC)
\begin{figure}[!h]
\begin{center}
\textbf{ \hspace{0.5 cm} (A) \hspace{4.4 cm} (B)} \\
\vspace{-0.2 cm}
\includegraphics[width=5 cm]{./Results/age_str_results/extrisk_age_str_C_SC_linear.pdf}
\includegraphics[width=5 cm]{./Results/age_str_results/extrisk_age_str_C_SC_nonlinear_omg_100.pdf}
\caption[Extinction risk from single patch age structured models with time when vital rates have either left (C) or right tail (SC) association.]{Extinction risk (shading represents 95\% confidence interval) from single patch age structured models with time for 10000 simulations. Fecundity of adults and survival of eggs have moderate tail association in either left or right tail in their corresponding copula structure. Moderate left tail association (or right tail association) was generated by a bivariate Clayton (or Survival Clayton) copula with Kendall correlation coefficient = 0.6, $(A)$ for linear model ($\Omega = \infty$) and for $(B)$ non-linear model ($\Omega = 100$).\label{fig_extrisk_agestr_mtd}}
\end{center}
\end{figure}-->


<!--FIG:  summary: all nonlinear model results for global dispersion: extrisk vs. d-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=15 cm]{./Results/allmodel_ext_risk_global_disp_extreme_and_moderate_noise.pdf}
\caption[Extinction risk vs. dispersal rate for six density dependent metapopulation model with global dispersal.]{Analogous figure as of Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text but for global dispersal between metapopulation patches.\label{fig_extrisk_allmodel_globaldisp}}
\end{center}
\end{figure}


<!--FIG: Ricker model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/ricker_scl_1/ricker_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Effect of tail association in environmental noises on extinction risk for Ricker metapopulation model with local dispersal.]{Effect of tail association in environmental noises on extinction risk (calculated after 25 years)
for $5$ metapopulation patches which followed Ricker dynamics with local dispersal; 
standard deviation $\sigma$=1 was used to generate extreme extreme tail dependent noises for 10000 simulations. \label{fig_ricker_risk_local_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG : Hassell model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/hassell_scl_1/hassell_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Effect of tail association in environmental noises on extinction risk for Hassell metapopulation model with local dispersal.]{Effect of tail association in environmental noises on extinction risk (calculated after 25 years)
for $5$ metapopulation patches which followed Hassell dynamics with local dispersal; 
standard deviation $\sigma$=1 was used to generate extreme tail dependent noises for 10000 simulations. \label{fig_hassell_risk_local_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG: Maynard smith model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/msmith_scl_0.8/msmith_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Effect of tail association in environmental noises on extinction risk for Maynard smith metapopulation model with local dispersal.]{Effect of tail association in environmental noises on extinction risk (calculated after 25 years) for $5$ metapopulation patches which followed Maynard Smith dynamics with local dispersal; 
standard deviation $\sigma$=0.8 was used to generate extreme tail dependent noises for 10000 simulations. \label{fig_msmith_risk_local_disp_scl_0.8}}
\end{center}
\end{figure}

<!--FIG: Pennycuick model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/pennycuick_scl_1/pennycuick_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Effect of tail association in environmental noises on extinction risk for Pennycuick metapopulation model with local dispersal.]{Effect of tail association in environmental noises on extinction risk (calculated after 25 years)
for $5$ metapopulation patches which followed Pennycuick dynamics with local dispersal; 
standard deviation $\sigma$=1 was used to generate extreme tail dependent noises for 10000 simulations. \label{fig_risk_local_disp_pennycuick_r_vary_scl_1}}
\end{center}
\end{figure}

<!--FIG: Verhulst model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/verhulst_scl_0.6/verhulst_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Effect of tail association in environmental noises on extinction risk for Verhulst metapopulation model with local dispersal.]{Effect of tail association in environmental noises on extinction risk (calculated after 25 years)
for $5$ metapopulation patches which followed Verhulst dynamics with local dispersal; 
standard deviation $\sigma$=0.6 was used to generate extreme tail dependent noises for 10000 simulations. \label{fig_risk_local_disp_verhulst_r_vary_scl_0.6}}
\end{center}
\end{figure}

<!--FIG: Austin-Brewer model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/austinbrewer_scl_0.6/abrewer_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Effect of tail association in environmental noises on extinction risk for Austin-Brewer metapopulation model with local dispersal.]{Effect of tail association in environmental noises on extinction risk (calculated after 25 years) for $5$ metapopulation patches which followed Austin-Brewer dynamics with local dispersal; 
standard deviation $\sigma$=0.6 was used to generate extreme tail dependent noises for 10000 simulations. \label{fig_risk_local_disp_abrewer_r_vary_scl_0.6}}
\end{center}
\end{figure}


<!--FIG : Ricker model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/ricker_scl_1/ricker_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Analogous figure as of Fig. \ref{fig_ricker_risk_local_disp_scl_1} but for global dispersal between metapopulation patches.]{Analogous figure as of Fig. \ref{fig_ricker_risk_local_disp_scl_1} but for global dispersal between metapopulation patches. \label{fig_ricker_risk_global_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG: Hassell model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/hassell_scl_1/hassell_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Analogous figure as of Fig. \ref{fig_hassell_risk_local_disp_scl_1} but for global dispersal between metapopulation patches.]{Analogous figure as of Fig. \ref{fig_hassell_risk_local_disp_scl_1} but for global dispersal between metapopulation patches. \label{fig_hassell_risk_global_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG: Maynard smith model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/msmith_scl_0.8/msmith_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Analogous figure as of Fig. \ref{fig_msmith_risk_local_disp_scl_0.8} but for global dispersal between metapopulation patches.]{Analogous figure as of Fig. \ref{fig_msmith_risk_local_disp_scl_0.8} but for global dispersal between metapopulation patches. \label{fig_msmith_risk_global_disp_scl_0.8}}
\end{center}
\end{figure}

<!--FIG: Pennycuick model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/pennycuick_scl_1/pennycuick_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Analogous figure as of Fig. \ref{fig_risk_local_disp_pennycuick_r_vary_scl_1} but for global dispersal between metapopulation patches.]{Analogous figure as of Fig. \ref{fig_risk_local_disp_pennycuick_r_vary_scl_1} but for global dispersal between metapopulation patches. \label{fig_risk_global_disp_pennycuick_r_vary_scl_1}}
\end{center}
\end{figure}

<!--FIG: Verhulst model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/verhulst_scl_0.6/verhulst_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Analogous figure as of Fig. \ref{fig_risk_local_disp_verhulst_r_vary_scl_0.6} but for global dispersal between metapopulation patches.]{Analogous figure as of Fig. \ref{fig_risk_local_disp_verhulst_r_vary_scl_0.6} but for global dispersal between metapopulation patches. \label{fig_risk_global_disp_verhulst_r_vary_scl_0.6}}
\end{center}
\end{figure}

<!--FIG: Austin brewer model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/austinbrewer_scl_0.6/abrewer_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Analogous figure as of Fig. \ref{fig_risk_local_disp_abrewer_r_vary_scl_0.6} but for global dispersal between metapopulation patches.]{Analogous figure as of Fig. \ref{fig_risk_local_disp_abrewer_r_vary_scl_0.6} but for global dispersal between metapopulation patches. \label{fig_risk_global_disp_abrewer_r_vary_scl_0.6}}
\end{center}
\end{figure}

# Generating noise with asymmetric tail associations  \label{makenoise}

<!--needs editing, I just dumped old text here-->

Copula, a rank based measure of association, is much more informative 
than linear correlation measure and a widely applied tool in dependence 
modeling [@joe2014_dependence; @nelsen2006_copula]. Copulas separate 
the information content of a bivariate dataset,
$(x_n, y_n)$ for $n = 1 \ldots N$, into two non-overlapping parts: the information in the marginal 
distributions (which is not about the association between the variables) and the rest of 
the information (which is solely about the association). The association information is revealed by 
the copula plot ($v_n$ against $u_n$) of the raw variables ($y_n$ vs. $x_n$) in Fig...., where 
$u_n$ is the rank of $x_n$ in the set ${x_1, x_2, \ldots , x_n }$, divided by $N + 1$; 
and $v_n$ is the rank of $y_n$ in the set ${y_1, y_2, \ldots , y_n }$, also divided
by $N + 1$. Here the rank of the smallest element of each sets is considered to be 1 and the rank of
the largest element is $N$. We refer to the $u_n$ and $v_n$ as normalized ranks of the $x_n$ and $y_n$. 
Ranking makes the marginal distributions uniform, isolating only the information on 
association between the variables. 

<!--# Algorithm to generate extreme tail association  \label{extr_tail_dep}-->

For extreme tail association algorithm, a $N \times n$ matrix, M was generated of independent 
standard-normal random draws (in general). <!--where $N = numsteps(=25) \times numsims(=10000)$ : only for 2d case-->
Then, each row of M was identified for a first set of modifications
randomly and independently with a 50\% chance; for those rows identified, every
element of the row was replaced with the absolute
value of the first element of the row (including the first element itself).
For other rows, every element in the row was replaced by the negative of 
its own absolute value. This produces right-tail dependent
matrix, normally distributed for each column. If left-tail 
dependent noise is desired, take the negative of the entire matrix.
Our [code](https://github.com/sghosh89/ERC/blob/master/ExtremeTailDep.R) for
generating extreme tail association matrix is flexible enough, so that 
matrix M can be generated initially with independent random draws from a normal 
distribution with a specified mean and standard deviation.

<!--some stuff that used to be in the main text-->

The moderate tail association was modeled by using the 
concept of "copula", a statistical tool to model 
dependencies. Appendix \ref{SM-intro_copula} summarized
a brief introduction of "copulas" and their relation to tail associations, symmetries 
with examples of available copula families 
from `R` packages (`copula` and `VineCopula`). We used bivariate Clayton 
copula to model moderate left-tail and Survival Clayton copula to model 
moderate right-tail association in the vital rates. Both copulae had the same Spearman 
correlation ($\rho =$ `r srho_common`) but opposite association in their respective tails. 
We generated a $N \times 2$ matrix, M, for each of the left (Clayton) and 
right (Survival Clayton) tail associated bivariate copulas (see `BiCopSim` function from
`VineCopula` package ), where $N$ is number of years ($=25$) multiplied 
by number of simulations ($=10000$) we used. 
We chose parameters for each copula family using 
`iRho` function from `copula` package so that both copula had
same Spearman correlation ($\rho =$ `r srho_common`). Entries within each column of
matrix $M$, then became independent of each other but 
entries between columns had a specific tail association
with positive Spearman correlation. 

<!--some more stuff from the main text-->

On a similar note, we generated extreme left- (or right-) tail dependent matrix (M)
from standard iid (Appendix \ref{SM-extr_tail_dep}) and made the marginals uniform so that
it could mimic an extreme tail dependent copula. We made the first column of matrix 
$M$ as gamma ($\Gamma(k,\theta)$) distributed 
with shape parameter $k = 2$ and scale parameter $\theta = 1$.
This distribution represented fecundity of the adult population, $f_a \geq 0$.
For a given $\theta$, increasing $k$ would shift the distribution towards
higher fecundity and reduce the extinction risk if the other parameters
remain unchanged. We took the second column of $M$ and applied a 
beta ($\mathcal{B}(\alpha,\beta)$) transformation. $\alpha =3$ and
$\beta = 2$ were the shape parameters that could control the distribution 
of the survival rates of eggs ($s_e$) ranging in between 0 to 1. 
For each $25$ timesteps from each of $10000$ simulations,
we incorporated pairwise entries from each row of matrix $M$ in the expression for 
vital rates (fecundity $f_a$ and survival rates $s_e$, Eq. \ref{eq_vitalrates}) of 
the stochastic projrction matrix in model (\ref{eq_age_str}).

<!--yet more stuff from the main text-->

For moderately left-tail associated 
noises we drew points from a $n$ dimensional 
Clayton copula with same Spearman correlation ($\rho =$ `r srho_common`) between
any two out of $n$ patches and made 
the marginals normal with zero mean and standard deviation $\sigma$ 
(see the specified value $\sigma$ for each model in 3$^{rd}$ 
column of Table \ref{tab_model_summary}). For moderately 
right-tail associated noises we flipped ($180^{\circ}$ rotation) the points drawn 
from Clayton copula so that all the statistical properties remained 
same except for the direction of tail association. We generated
extreme left- or right-tail associated noises via algorithm stated in 
Appendix \ref{SM-extr_tail_dep}. 

# Stability analysis of deterministic metapopulation models  \label{model_stability}

First, we will briefly discuss about the stability analysis for a difference 
equation which is frequently used in population ecology model. Let's say, $P(t+1) = F(P(t),r)$
represents the model dynamics of a single population $P$ which progress recursively via 
a nonlinear density-dependence function $F$ with discrete time variable $t$. $r$ is the model parameter 
which plays major role in assessing the model's dynamical stability. Fixed-point analysis can
be used to get information about this type of nonlinear difference equation. The idea is to
employ the concept that the system at fixed point (or equilibrium $P_e$) does not change with time 
(i.e. $P(t+1) = P(t)$). Given a tiny perturbation from its equilibrium $P_e$, if the system 
returns to its initial state, then $P_e$ is called to be a stable equilibrium, otherwise unstable.
Mathematically, from standard linear stability analysis we can say an equilibrium is locally 
asymptotically stable if $| {F}' | < 1$, where ${F}' = \left( \frac{\mathrm{d}F }{\mathrm{d} P} \right) _{P(t)=P_e}$.
If the approach towards its equilibrium is monotonic (when $0<{F}'<1$), the dynamics is said to be
in under-compensatory regime. An over-compensatory dynamics means the approach towards its stable equlibrium
is oscillatory ($-1<{F}'<0$). Following we will describe stability condition of the model dynamics considered for each 
patch of metapopulation models in the maintext (see Table \ref{MT-tab_model_summary}).

**Ricker model** [@ricker1954stock; @may1976bifurcations], originally introduced in the context of modelling
stock and recruitment of salmon populations, is a classic 
discrete population model 
and frequently used in fisheries management problem. The model dynamics
is represented as 
$P(t+1)=F(P(t),r,K)=P(t) \exp[r(1-P(t)/K)]$, where $P$ is the population density, $r>0$ is the intrinsic 
growth rate and $K>0$ is the carrying capacity. There are two equilibrium states ($P_e = 0, K$).
The equilibrium at ($P_e = 0$) is unstable as ${F}' = \exp(r) > 1$ for a positive $r$ and considered 
as the extinction equilibrium 
in population ecology context. Depending on parameter $r$, 
the other equilibrium $P_e = K$ can be stable or unstable as ${F}' = (1-r)$. Following generalized
concept, the model can show monotonic approach to its stable equilibrium $P_e = K$ if $0<r<1$ 
or can approach $P_e = K$ in an oscillating fashion if $1<r<2$. When 
$r>2$ (i.e., ${F}'<-1$), system shows sustained oscillation and the equilibrium becomes unstable. We called $r=1$ 
as $r_c$, the critical point where system goes from under- to over-compensatory regime and 
$r=2$ as $r_{bf}$ where bifurcation (transition from stable to unstable equilibrium) occurs.

**Hassell model** [@hassell1975density; @may1976bifurcations], motivated for modelling insect populations,
can be represented as $P(t+1) = F(P(t),r,a,b)=rP(t)/(1+aP(t))^b$, where $r>0$ is the intrinsic growth rate 
of population density $(P)$. $a$ and $b$ are the other positive parameters. If $b=1$, it reduces to
Beverton-Holt model [@beverton2012dynamics] used in fisheries. In general, if $b \sim 1$,
then we say that there is contest and $F$ will saturate eventually at a finite
level for large populations, which indicates that the population stabilizes by
rejecting too many newborns. For scramble, $b$ is large and $F$ tends to
zero for large populations which indicates that the resources are over-utilized
leading to eventual extinction. Like Ricker, Hassel model too has two equilibrim:
$P_e =0$ (trivial extinction equilibrium) and $P_e = P^\star =(r^{1/b}-1)/a$. 
For $P_e = P^\star$, model remains in under-compensatory regime if $1<r<[b/(b-1)]^b$ 
and in over-compensatory regime if $[b/(b-1)]^b<r<[b/(b-2)]^b$ with $r_c = [b/(b-1)]^b$.
Hopf bifurcation occurs at $r_{bf} = [b/(b-2)]^b$, so if $r>r_{bf}$, $P_e=P^\star$
becomes unstable equilibrium.

**Maynard Smith model** [@cohen1995unexpected; @maynard1978models; @may1976bifurcations] follows the dynamics 
$P(t+1)=F(P(t),r,a,b)=rP(t)/[1+(aP(t))^b]$. $r$ is the growth rate, $a, b$ are the parameters with positive values.
Equilibriums are: $P_e=0$(as expected extinction equilibrium) and $P_e = P^\star=\frac{1}{a}(r-1)^{1/b}$.
For a positive equilibrium value of $P^\star$, $r$ must be greater than $1$. This $P^\star$ will be stable
in under-compensatory regime for $1<r<r_c(=b/(b-1))$ and in over-compensatory regime for $r_c<r<b/(b-2)$.
$P^\star$ will become unstable when $r>r_{bf}(=b/(b-2))$. 

**Pennycuick model** [@pennycuick1968computer; @may1976bifurcations] was 
initially developed
to follow change in age-structured total population
level which assumed
to have a constant sex 
ratio and therefore change in female population was 
expected through the change 
in total population density. 
A two population variant could also be possible
in prey-predator perspective as indicated in [@pennycuick1968computer].
In general, model dynamics is expressed as $P(t+1)=F(P(t),r,a,b)=rP(t)/[1+\exp \left\{-a(1-P(t)/b)\right\}]$, where 
$r$ is the intrinsic growth rate and $a>0,b>0$ are the model parameters. Model
equilibriums are 
$P_e=0$ (extinction equilibrium) and $P_e=P^\star=\frac{b}{a}[a+\ln{(r-1)}]$. For 
a finite equilibrium population 
$r$ must be greater than $r_{min}$, where 
$r_{min} = 1+\exp(-a)$. The critical transition point $r_c$ (from under- to 
over-compensatory dynamics) and Hopf-bifurcation point $r_{bf}$ can be obtained
by numerical solution of ${F}'=0$ and ${F}'=-1$ at $P_e=P^{\star}$, respectively.

**Verhulst model** [@cohen1995unexpected; @may1976bifurcations] is a discrete time difference 
representation of logistic growth of non-human biological population and can be written 
as $P(t+1) = F(P(t),r,K) =P(t)[1+r(1-P(t)/K)]$, with $r>0$ and $K>0$ being growth rate and carrying capacity, respectively. 
Model equilibrium $P_e=0$ is always unstable whereas $P_e=K$ is stable below Hopf-bifurcation 
point $r_{bf}(=2)$. Model at stable equilibrium ($P_e=K$) lies in the under-compensatory regime when $0<r<r_c$
and in over-compensatory regime when $rc<r<r_{bf}$ with $r_c$ being equal to 1.

**Austin-Brewer model** [@austin1971world; @cohen1995unexpected], unlike from the first
five models we considered,
is used to model growth of human population. It follows the
discrete dynamics : $P(t+1) = F(P(t),r,K,s)= P(t)[1+r(K-P(t)) \left\{ 1-\exp (-sP(t))\right\}]$, where
$r, K, s$ are positive, representing growth rate, carrying capacity 
and model parameter, respectively.
Usual extinction equilibrium is $P_e=0$. The other
finite, positive equilibrium is $P_e=P^\star=1-rK\left\{ 1-\exp (-sK)\right\}$. The equilibrium $P^\star$
is stable when $r<r_{bf}$ and unstable beyond the bifurcatio point $r_{bf} = \frac{2}{K[1-\exp (-sK)]}$.
After perturbation, model can return back monotonically to its stable equilibrium if parameter $r$ lies in the 
under-compensatory regime ($0<r<r_c$), where $r_c = \frac{1}{K[1-\exp (-sK)]}$. In the 
over-compensatory regime ($r_c<r<r_{bf}$), model approaches to stable equilibrium $P^\star$
in oscillatory fashion.

\clearpage

# References 
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{1pt}
\noindent













