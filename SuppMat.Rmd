---
title: "Supporting information: Tail associations and their impact on extinction risk"
author: "Shyamolina Ghosh, Daniel Reuman"
date: ""
geometry: "left=1in,right=1in,top=1in,bottom=1in"

output: 
  pdf_document:
    number_sections: yes
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: head_suppmat.sty
      
tables: True
link-citations: True
urlcolor : blue
indent : True

csl: TheAmericanNaturalist.csl
bibliography: Ref_extrisk.bib
---

\pagenumbering{roman}
\tableofcontents
\listoffigures

\pagebreak
\pagenumbering{arabic}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
library(abind)
source("mtime.R")
```

```{r get_srho_common, echo=F, results="hide", cache=T, cache.extra=list(seed,mtime("ExtremeTailDep.R"))}
set.seed(seed)
library(copula)
source("./ExtremeTailDep.R")

np<-1000000
srho_common<-0.875 #7/8

xtc_r<-retd(n=np,d=2,rl=1,mn=0,sdev=1) # copula with extreme right tail

saveRDS(srho_common,"./Results/srho_common.RDS") 
  
# flip xtc_r to get xtc_l
#xtc_l<-1-xtc_r

# make marginals uniform 
xtc_r<-pnorm(xtc_r)
xtc_l<-1-xtc_r
  
# for clayton : left tail dep.
copC<-claytonCopula(3)
parC<-iRho(copC,rho=srho_common)
  
# first generate Clayton copula 
cc<-claytonCopula(par=parC,dim=2)
mtc_l<-rCopula(np,cc)  
  
# flip Clayton copula 
mtc_r<-1-mtc_l

# calculate rho with sampling variation
scor_el<-cor(xtc_l,xtc_l,method = "spearman")
scor_el<-scor_el[1,2]

scor_er<-cor(xtc_r,xtc_r,method = "spearman")
scor_er<- scor_er[1,2] 

scor_ml<-cor(mtc_l,mtc_l,method = "spearman")
scor_ml<- scor_ml[1,2]

scor_mr<-cor(mtc_r,mtc_r,method ="spearman")
scor_mr<- scor_mr[1,2] 
```


```{r plot_intro_fig, echo=F, results="hide"}

#--------- Plot for intro + methods ------------------------------------

# for plotting purpose I just showed only first 500 points

pdf("./Results/introfig_copula.pdf", height=3, width=12)
op<-par(mfrow=c(1,4),mar=c(6,6,2,2),mgp=c(3,1,0))

# extreme left tail
plot(xtc_l[1:500,1],xtc_l[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
#legend(x="topleft",legend="A",bty="n",cex=2.5)
text(x=0.1,y=0.9,"A",cex=2.5)
text(x=0.8,y=0.1,round(scor_el,4),cex=2)

# moderate left tail
plot(mtc_l[1:500,1],mtc_l[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
text(x=0.1,y=0.9,"B",cex=2.5)
text(x=0.8,y=0.1,round(scor_ml,4),cex=2)

# moderate right tail
plot(mtc_r[1:500,1],mtc_r[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
text(x=0.1,y=0.9,"C",cex=2.5)
text(x=0.8,y=0.1,round(scor_mr,4),cex=2)

# extreme right tail
plot(xtc_r[1:500,1],xtc_r[1:500,2],col=rgb(0,0,0,0.1),pch=19,xlab="u",ylab="v",cex.lab=2.5,cex.axis=2)
text(x=0.1,y=0.9,"D",cex=2.5)
text(x=0.8,y=0.1,round(scor_er,4),cex=2)

par(op)
dev.off()


#========== Schematic fig for partial spearman correlation ==============
pdf("./Results/PartialSpearmanFig.pdf", width=6, height=6)
op<-par(mar=c(6,6,2,2),mgp=c(3,1,0))
plot(mtc_r[1:150,1],mtc_r[1:150,2],type='p',pch=19,col=rgb(0,0,0,0.15),cex=1.5,
     cex.axis=2,cex.lab=2.5,xlab="x",ylab="y")
lines(c(0,0.3),c(0.3,0),type='l')
lines(c(0,0.6),c(0.6,0),type='l')
lines(c(0,1.4),c(1.4,0),type='l')
lines(c(0,1.7),c(1.7,0),type='l')
par(op)
dev.off()
```

```{r sim_linear_mtd, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("ext_risk_cop_age_str.R"))}
# extinction risk with moderate tail dep. for single patch linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")

numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-Inf
srho<-srho_common  # Spearman's rho

# for clayton
copC<-claytonCopula(3)
parC<-iRho(copC,rho=srho)
par<-parC
fam<-3

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

C_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(C_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
#---------------------------------------------------------------------------------

# Now for survival clayton : should be the same parameter as of clayton if Spearman's rho is the same 

fam<-13
par<-parC

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

SC_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(SC_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
```

```{r fig_agestr_mtd_linear, echo=F,results="hide"}
xL<-C_age$extdf
xR<-SC_age$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_C_SC_linear.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("moderate LT","moderate RT", expression(paste(Omega,"= ", infinity))), lty=c(1,1, NA),  
       col=c('red', 'blue', NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_nonlinear_mtd, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("ext_risk_cop_age_str.R"))}
# extinction risk with moderate tail dep. for single patch non-linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")

numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-100
srho<-srho_common  # Spearman's rho

# for clayton
copC<-claytonCopula(3)
parC<-iRho(copC,rho=srho)
par<-parC
fam<-3

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_nonlinear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

C_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(C_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
#---------------------------------------------------------------------------------

# Now for survival clayton : should be the same parameter as of clayton if Spearman's rho is the same 

fam<-13
par<-parC

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_scor_",srho,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

SC_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(SC_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
```

```{r fig_agestr_mtd_nonlinear, echo=F,results="hide"}
xL<-C_age$extdf
xR<-SC_age$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_C_SC_nonlinear_omg_",omg,".pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("moderate LT","moderate RT", as.expression(bquote(Omega==.(omg)))), lty=c(1,1,NA),  
       col=c('red', 'blue',NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_agestr_with_extremetail_linear, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("ext_risk_cop_age_str.R"),mtime("ExtremeTailDep.R"))}
# extinction risk with extreme tail dep. for single patch linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")
source("ExtremeTailDep.R")
numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-Inf

# For extreme right tail dep.
mr<-retd(n = (numsteps*numsims),d = 2,rl =1,mn=0,sdev=1)
cop<-pnorm(mr) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_right_taildep_linear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_right_tail_cop.pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
las_exR<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(las_exR,paste(resloc,"sim_age_str_extreme_right_taildep.RDS",sep=""))

# For extreme left tail dep.
ml<-retd(n = (numsteps*numsims),d = 2,rl =-1,mn=0,sdev=1)
cop<-pnorm(ml) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_left_taildep_linear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_left_tail_cop.pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
 las_exL<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(las_exL,paste(resloc,"sim_age_str_extreme_left_taildep.RDS",sep=""))
```

```{r fig_agestr_with_extremetail_linear, echo=F,results="hide"}
xL<-las_exL$extdf
xR<-las_exR$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_extremetail_linear.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("extreme LT","extreme RT", expression(paste(Omega,"= ", infinity))), lty=c(1,1, NA),  
       col=c('red', 'blue', NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_agestr_with_extremetail_nonlinear, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("ext_risk_cop_age_str.R"),mtime("ExtremeTailDep.R"))}
# extinction risk with extreme tail dep. for single patch non-linear age structure model

set.seed(seed)
source("ext_risk_cop_age_str.R")
source("ExtremeTailDep.R")
numsims<-10000
numsteps<-25
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-100
# For extreme right tail dep.
mr<-retd(n = (numsteps*numsims),d = 2,rl =1,mn=0,sdev=1)
cop<-pnorm(mr) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_right_taildep_nonlinear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_right_tail_cop_omg_",omg,".pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
nlas_exR<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(nlas_exR,paste(resloc,"sim_age_str_extreme_right_taildep.RDS",sep=""))
 # For extreme left tail dep.
ml<-retd(n = (numsteps*numsims),d = 2,rl =-1,mn=0,sdev=1)
cop<-pnorm(ml) # to make normal to uniformly distributed
 tempo<-paste("./Results/age_str_results/extreme_left_taildep_nonlinear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")
pdf(paste(resloc,"extreme_right_tail_cop_omg_",omg,".pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()
nlas_exL<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(nlas_exL,paste(resloc,"sim_age_str_extreme_left_taildep.RDS",sep=""))
```

```{r fig_agestr_with_extremetail_nonlinear, echo=F,results="hide"}
xL<-nlas_exL$extdf
xR<-nlas_exR$extdf
t<-c(0:(nrow(xL)-1))
pdf(paste("./Results/age_str_results/extrisk_age_str_extremetail_nonlinear_omg_",omg,".pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=2,cex.axis=1.5)
x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")
x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,1,0.3), border = NA)
lines(t,x$erA,col="blue",type="l")
legend(x=-2,y=1.05, c("extreme LT","extreme RT", as.expression(bquote(Omega==.(omg)))), lty=c(1,1,NA),  
       col=c('red', 'blue',NA), horiz=F, bty='n', cex=1.5, x.intersp = 0.2
       #, seg.len = 1
       )
par(op)
dev.off()
```

```{r sim_ricker_scl_1, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

rc_ricker<-1 # transition from under to overcompensatory dynamics
r_bf_ricker<-2 # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=0,max=r_bf_ricker)
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_ricker)
q2<-abs(unname(qr1[2])-rc_ricker)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Ricker model !!!",immediate.=T,call.=T)
}

numsims<-10000
numsteps<-25
numlocs<-5
K<-50
scl<-1
srho<-srho_common
ext_thrs<-K/10
model<-"ricker"

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

#initiate a dataframe to store ext risk at dispersal d=0 for all r
ricker_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                              NA*numeric(length(rlist)),NA*numeric(length(rlist))) 
colnames(ricker_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

res_ricker_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,K)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_ricker_local<-abind(res_ricker_local,temp_mat,along = 3)
      
    ricker_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    ricker_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    ricker_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    ricker_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_ricker_local)<-list(NULL,cnm,anm)

saveRDS(ricker_extrisk_d0,paste(resloc,"ricker_extrisk_d0.RDS",sep=""))
saveRDS(res_ricker_local,paste(resloc,"res_ricker_local.RDS",sep=""))

# For global dispersion
res_ricker_global<-c()

for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,K)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_ricker_global<-abind(res_ricker_global,temp_mat,along = 3)
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_ricker_global)<-list(NULL,cnm,anm)
saveRDS(res_ricker_global,paste(resloc,"res_ricker_global.RDS",sep=""))
```

```{r fig_ricker_scl_1, echo=F, results="hide",cache=T, cache.extra=list(seed,res_ricker_local,res_ricker_global)}

pdf("./Results/common_legend_extreme_noise.pdf",height=1,width=12)
op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("center", c("noise: extreme LTdep.","noise: extreme RTdep."), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'),x.intersp = 0.2,
         cex = 2.5, xpd = TRUE, horiz = T, inset = c(0,0), 
         bty = "n")
par(op)
dev.off()

pdf("./Results/common_legend_moderate_noise.pdf",height=1,width=12)
op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("center", c("noise: moderate LTdep.","noise: moderate RTdep."), lty=c(1,1), pch=c(1,1), 
         col=c('red', 'blue'),x.intersp = 0.2,
         cex = 2.5, xpd = TRUE, horiz = T, inset = c(0,0), 
         bty = "n")
par(op)
dev.off()

pdf("./Results/common_legend_extreme_and_moderate_noise.pdf",height=1,width=12)
op<-par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0))
plot(0, 0, type = "n", bty = "n", xaxt = "n", yaxt = "n")
legend("center", c("extreme LT,","moderate LT,", "moderate RT,","extreme RT"), lty=c(1,1), pch=c(1,1,1,1), 
         col=c('red', 'orange','skyblue','blue'),x.intersp = 0.1,
         cex = 2.2, xpd = TRUE, horiz = T, inset = c(0,0), 
         bty = "n")
par(op)
dev.off()

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_ext_risk_local_disp_extremenoise.pdf",sep=""),height=9,width=9)
#op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_local)[3]){
  #s<-res_ricker_local[,,i]
  ss<-res_ricker_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"ricker_ext_risk_global_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_global)[3]){
  #ss<-res_ricker_global
  ss<-res_ricker_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"ricker_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=9,width=9)

op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_local)[3]){
  #s<-res_ricker_local[,,i]
  ss<-res_ricker_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"ricker_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_global)[3]){
  #ss<-res_ricker_global
  ss<-res_ricker_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#----------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
#op<-par(mfrow=c(3,3),mar=c(5.2,4.2,1.2,6.2))
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_local)[3]){
  #s<-res_ricker_local[,,i]
  ss<-res_ricker_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"ricker_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_ricker_global)[3]){
  #ss<-res_ricker_global
  ss<-res_ricker_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_ricker_extrisk_d0_scl_1, echo=F,results="hide"}
set.seed(seed)

ricker_extrisk_d0<-readRDS(paste(resloc,"ricker_extrisk_d0.RDS",sep=""))
numsims<-10000
ricker_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_xleft_d0)/numsims
ricker_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_xleft_d0)/numsims

ricker_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_xright_d0)/numsims
ricker_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_xright_d0)/numsims

ricker_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_mleft_d0)/numsims
ricker_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_mleft_d0)/numsims

ricker_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=ricker_extrisk_d0$risk_mright_d0)/numsims
ricker_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=ricker_extrisk_d0$risk_mright_d0)/numsims

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xleft_d0,col="red",type="b",
     ylim=c(0,1),xlim = range(ricker_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xleft,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975xleft,
       angle=90,length=0.1,col="red",code=3)
abline(v=rc_ricker,lty="dotted",col="black") #rc=1

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xright,x1=ricker_extrisk_d0$r,
       y1=ricker_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Ricker"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.95, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", legend=c("Ricker",paste0("K = ",K)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mleft_d0,col="red",type="b",
     ylim=c(0,1),xlim = range(ricker_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mleft,x1=ricker_extrisk_d0$r,
       y1=ricker_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_ricker,lty="dotted",col="black") #rc=1

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mright,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Ricker"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.95, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", legend=c("Ricker",paste0("K = ",K)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"ricker_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xleft_d0,col="red",type="b",
     ylim=c(0,1),xlim = range(ricker_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xleft,x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975xleft,
       angle=90,length=0.1,col="red",code=3)
abline(v=rc_ricker,lty="dotted",col="black") #rc=1

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mleft,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025mright,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(ricker_extrisk_d0$r,ricker_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=ricker_extrisk_d0$r,y0=ricker_extrisk_d0$CI0.025xright,
       x1=ricker_extrisk_d0$r,y1=ricker_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Ricker"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.95, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r sim_hassell_scl_1, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"hassell"

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-100
scl<-1
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

rc_hassell<-((b/(b-1)))^b # transition from under to overcompensatory dynamics
r_bf_hassell<- ((b/(b-2)))^b # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=1,max=r_bf_hassell) # r must be > 1
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_hassell)
q2<-abs(unname(qr1[2])-rc_hassell)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Hassell model !!!",immediate.=T,call.=T)
}

hassell_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                               NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                       # ext risk at dispersal d=0 for all r
colnames(hassell_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

res_hassell_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_hassell_local<-abind(res_hassell_local,temp_mat,along = 3)
      
    hassell_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    hassell_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    hassell_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    hassell_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_hassell_local)<-list(NULL,cnm,anm)

saveRDS(hassell_extrisk_d0,paste(resloc,"hassell_extrisk_d0.RDS",sep=""))
saveRDS(res_hassell_local,paste(resloc,"res_hassell_local.RDS",sep=""))

# For global dispersion
res_hassell_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    K_e<-((r^(1/b))-1)/a
    ext_thrs<-K_e/10
    params<-c(r,a,b)
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_hassell_global<-abind(res_hassell_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_hassell_global)<-list(NULL,cnm,anm)
saveRDS(res_hassell_global,paste(resloc,"res_hassell_global.RDS",sep=""))
```

```{r fig_hassell_scl_1, echo=F, results="hide",cache=T, cache.extra=list(seed,res_hassell_local,res_hassell_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"hassell_ext_risk_local_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_local)[3]){
  ss<-res_hassell_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"hassell_ext_risk_global_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_global)[3]){
  ss<-res_hassell_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"hassell_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_local)[3]){
  ss<-res_hassell_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"hassell_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_global)[3]){
  ss<-res_hassell_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#----------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"hassell_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_local)[3]){
  ss<-res_hassell_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
 
}
par(op)
dev.off()


pdf(paste(resloc,"hassell_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_hassell_global)[3]){
  ss<-res_hassell_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_hassell_extrisk_d0_scl_1, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
hassell_extrisk_d0<-readRDS(paste(resloc,"hassell_extrisk_d0.RDS",sep=""))

hassell_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_xleft_d0)/numsims
hassell_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_xleft_d0)/numsims

hassell_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_xright_d0)/numsims
hassell_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_xright_d0)/numsims

hassell_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_mleft_d0)/numsims
hassell_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_mleft_d0)/numsims

hassell_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=hassell_extrisk_d0$risk_mright_d0)/numsims
hassell_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=hassell_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"hassell_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(hassell_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_hassell,lty="dotted",col="black")

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xright,x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Hassell"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Hassell",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"hassell_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(hassell_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_hassell,lty="dotted",col="black")

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mright,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Hassell"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Hassell",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"hassell_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(hassell_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_hassell,lty="dotted",col="black")

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mleft,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025mright,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(hassell_extrisk_d0$r,hassell_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=hassell_extrisk_d0$r,y0=hassell_extrisk_d0$CI0.025xright,
       x1=hassell_extrisk_d0$r,y1=hassell_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Hassell"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```


```{r sim_msmith_scl_0.8, echo=F, cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"msmith"
scl<-0.8
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-0.5
b<-4

rc_msmith<-b/(b-1)
r_bf_msmith<-b/(b-2) # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=1,max=r_bf_msmith) #r must be > 1 for +ve eqm pt.
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_msmith)
q2<-abs(unname(qr1[2])-rc_msmith)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Maynard-smith model !!!",immediate.=T,call.=T)
}

msmith_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                              NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                                     # ext risk at dispersal d=0 for all r
colnames(msmith_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_msmith_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_msmith_local<-abind(res_msmith_local,temp_mat,along = 3)
      
    msmith_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    msmith_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    msmith_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    msmith_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_msmith_local)<-list(NULL,cnm,anm)

saveRDS(msmith_extrisk_d0,paste(resloc,"msmith_extrisk_d0.RDS",sep=""))
saveRDS(res_msmith_local,paste(resloc,"res_msmith_local.RDS",sep=""))

# For global dispersal in D matrix 
res_msmith_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,a,b)
    K_e<-((r-1)^(1/b))/a
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_msmith_global<-abind(res_msmith_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_msmith_global)<-list(NULL,cnm,anm)
saveRDS(res_msmith_global,paste(resloc,"res_msmith_global.RDS",sep=""))
```

```{r fig_msmith_scl_0.8, echo=F, results="hide",cache=T, cache.extra=list(seed,res_msmith_local,res_msmith_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"msmith_ext_risk_local_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_msmith_local)[3]){
  ss<-res_msmith_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"msmith_ext_risk_global_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5))

for(i in 1:dim(res_msmith_global)[3]){
  ss<-res_msmith_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       #panel.first = grid(),
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  #legend("bottomleft", c("noise : left","noise : right"), lty=c(1,1), pch=c(1,1), 
  #       col=c('red', 'blue'), horiz=T, bty='n', cex=1.2)
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"msmith_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_msmith_local)[3]){
  ss<-res_msmith_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"msmith_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5))

for(i in 1:dim(res_msmith_global)[3]){
  ss<-res_msmith_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#---------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"msmith_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_msmith_local)[3]){
  ss<-res_msmith_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"msmith_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5))

for(i in 1:dim(res_msmith_global)[3]){
  ss<-res_msmith_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_msmith_extrisk_d0_scl_0.8, echo=F,results="hide"}
set.seed(seed)

msmith_extrisk_d0<-readRDS(paste(resloc,"msmith_extrisk_d0.RDS",sep=""))
numsims<-10000
msmith_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_xleft_d0)/numsims
msmith_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_xleft_d0)/numsims

msmith_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_xright_d0)/numsims
msmith_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_xright_d0)/numsims

msmith_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_mleft_d0)/numsims
msmith_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_mleft_d0)/numsims

msmith_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=msmith_extrisk_d0$risk_mright_d0)/numsims
msmith_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=msmith_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"msmith_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(msmith_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_msmith,lty="dotted",col="black")

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xright_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xright,x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Maynard Smith"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"msmith_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(msmith_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_msmith,lty="dotted",col="black")

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mright_d0,col="blue",type="b",pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mright,x1=msmith_extrisk_d0$r,
       y1=msmith_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Maynard Smith"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"msmith_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(msmith_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_msmith,lty="dotted",col="black")

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mleft,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025mright,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(msmith_extrisk_d0$r,msmith_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=msmith_extrisk_d0$r,y0=msmith_extrisk_d0$CI0.025xright,
       x1=msmith_extrisk_d0$r,y1=msmith_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Maynard Smith"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r get_rc_pennycuick,echo=F,results="hide",cache=T,cache.extra=list(seed,mtime("bifurcation_pennycuick.R"))}
set.seed(seed)
source("./bifurcation_pennycuick.R")
a_pennycuick<-0.1
b_pennycuick<-0.1
eps<-1e-10 #you can change it upto which decimal point you want it to be exact
rlist<-seq(from=4.3231657,to=4.3231659,by=eps)
res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r,a_pennycuick,b_pennycuick),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)

rc_pennycuick<-rlist[which.min(abs(res_pennycuick-0))]
formatC(rc_pennycuick,digits = 10, format="f") # accurate upto 10th decimal

# This is to find the critical r value where stable to unstable eqm occurs
rlist<-seq(from=9.4672389,to=9.46724,by=eps)
#formatC(rlist,digits = 14, format="f") 

res_pennycuick<-c() 
for(r in rlist){
  ans<-fn_d1_eqm(params=c(r=r,a_pennycuick,b_pennycuick),model="pennycuick")
  res_pennycuick<-c(res_pennycuick,ans)
}

#plot(rlist,res_pennycuick,col="red",type="l",xlab="r",ylab="pennycuick_1st_der_at_eqm")
#abline(h=0)
#fp<-0
fp<--1
r_bf_pennycuick<-rlist[which.min(abs(res_pennycuick-fp))]
#formatC(rc_pen_uns,digits = 14, format="f") 
```

```{r sim_pennycuick_scl_1, echo=F, cache=T, cache.extra=list(seed,srho_common,a_pennycuick,b_pennycuick,rc_pennycuick,r_bf_pennycuick,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"pennycuick"
scl<-1
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
a<-a_pennycuick
b<-b_pennycuick

rng1<-runif(10000,min=(1+exp(-a)),max=r_bf_pennycuick) # for +ve eqm pt.
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_pennycuick)
q2<-abs(unname(qr1[2])-rc_pennycuick)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)
if(vxx>1e-10){
  warning("Not equal spacing in rlist : Pennycuick model !!!",immediate.=T,call.=T)
}

pennycuick_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                                  NA*numeric(length(rlist)),NA*numeric(length(rlist))) # a dataframe to store 
                                                                            # ext risk at dispersal d=0 for all r
colnames(pennycuick_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_pennycuick_local<-c()

for(i in c(1:length(rlist))){
    r<- rlist[i]
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_pennycuick_local<-abind(res_pennycuick_local,temp_mat,along = 3)
      
    pennycuick_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    pennycuick_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    pennycuick_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    pennycuick_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_pennycuick_local)<-list(NULL,cnm,anm)

saveRDS(pennycuick_extrisk_d0,paste(resloc,"pennycuick_extrisk_d0.RDS",sep=""))
saveRDS(res_pennycuick_local,paste(resloc,"res_pennycuick_local.RDS",sep=""))

# For global dispersal in D matrix 
res_pennycuick_global<-c()
for(r in rlist){
    #cat("r=",r,"\n")
    params<-c(r,a,b)
    K_e<-(b/a)*(a+log(r-1))
    ext_thrs<-K_e/10
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=K_e,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_pennycuick_global<-abind(res_pennycuick_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_pennycuick_global)<-list(NULL,cnm,anm)
saveRDS(res_pennycuick_global,paste(resloc,"res_pennycuick_global.RDS",sep=""))
```

```{r fig_pennycuick_scl_1, echo=F, results="hide",cache=T, cache.extra=list(seed,res_pennycuick_local,res_pennycuick_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"pennycuick_ext_risk_local_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.2,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_local)[3]){
  ss<-res_pennycuick_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
   mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"pennycuick_ext_risk_global_disp_extremenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_global)[3]){
  ss<-res_pennycuick_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"pennycuick_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.2,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_local)[3]){
  ss<-res_pennycuick_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
   mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"pennycuick_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_global)[3]){
  ss<-res_pennycuick_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#--------------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"pennycuick_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.2,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_local)[3]){
  ss<-res_pennycuick_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"pennycuick_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=12,width=12)
op<-par(mfrow=c(4,4),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_pennycuick_global)[3]){
  ss<-res_pennycuick_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_pennycuick_extrisk_d0_scl_1, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
pennycuick_extrisk_d0<-readRDS(paste(resloc,"pennycuick_extrisk_d0.RDS",sep=""))

pennycuick_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_xleft_d0)/numsims
pennycuick_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_xleft_d0)/numsims

pennycuick_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_xright_d0)/numsims
pennycuick_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_xright_d0)/numsims

pennycuick_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_mleft_d0)/numsims
pennycuick_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_mleft_d0)/numsims

pennycuick_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=pennycuick_extrisk_d0$risk_mright_d0)/numsims
pennycuick_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=pennycuick_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"pennycuick_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(pennycuick_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_pennycuick,lty="dotted",col="black")

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xright,x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Pennycuick"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Pennycuick",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"pennycuick_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(pennycuick_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_pennycuick,lty="dotted",col="black")

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mright,x1=pennycuick_extrisk_d0$r,
       y1=pennycuick_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Pennycuick"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Pennycuick",paste0("a = ",a," ,b = ",b),paste0("sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"pennycuick_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(pennycuick_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_pennycuick,lty="dotted",col="black")

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mleft,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025mright,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(pennycuick_extrisk_d0$r,pennycuick_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=pennycuick_extrisk_d0$r,y0=pennycuick_extrisk_d0$CI0.025xright,
       x1=pennycuick_extrisk_d0$r,y1=pennycuick_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Pennycuick"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("a = ",a,", b = ",b),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r sim_verhulst_scl_0.6, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"verhulst"
scl<-0.6
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
K<-1
p0<-K
ext_thrs<-p0/10
    
rc_verhulst<-1 # transition from under to overcompensatory dynamics
r_bf_verhulst<-2 # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=0,max=r_bf_verhulst)
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_verhulst)
q2<-abs(unname(qr1[2])-rc_verhulst)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Verhulst model !!!",immediate.=T,call.=T)
}

verhulst_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                                NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                   # ext risk at dispersal d=0 for all r
colnames(verhulst_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_verhulst_local<-c()

for(i in c(1:length(rlist))){
    r<-rlist[i]
    params<-c(r,K)
    
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_verhulst_local<-abind(res_verhulst_local,temp_mat,along = 3)
      
    verhulst_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
    verhulst_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
    
    verhulst_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
    verhulst_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_verhulst_local)<-list(NULL,cnm,anm)

saveRDS(verhulst_extrisk_d0,paste(resloc,"verhulst_extrisk_d0.RDS",sep=""))
saveRDS(res_verhulst_local,paste(resloc,"res_verhulst_local.RDS",sep=""))

# For global dispersal in D matrix 
res_verhulst_global<-c()
for(r in rlist){
    params<-c(r,K)
    
    ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
                 scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
    
    temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
    res_verhulst_global<-abind(res_verhulst_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_verhulst_global)<-list(NULL,cnm,anm)
saveRDS(res_verhulst_global,paste(resloc,"res_verhulst_global.RDS",sep=""))
```

```{r fig_verhulst_scl_0.6, echo=F, results="hide",cache=T, cache.extra=list(seed,res_verhulst_local,res_verhulst_global)}

#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"verhulst_ext_risk_local_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_local)[3]){
  ss<-res_verhulst_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"verhulst_ext_risk_global_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_global)[3]){
  ss<-res_verhulst_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"verhulst_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_local)[3]){
  ss<-res_verhulst_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"verhulst_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_global)[3]){
  ss<-res_verhulst_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#------------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"verhulst_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_local)[3]){
  ss<-res_verhulst_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

pdf(paste(resloc,"verhulst_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_verhulst_global)[3]){
  ss<-res_verhulst_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_verhulst_extrisk_d0_scl_0.6, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
verhulst_extrisk_d0<-readRDS(paste(resloc,"verhulst_extrisk_d0.RDS",sep=""))

verhulst_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_xleft_d0)/numsims
verhulst_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_xleft_d0)/numsims

verhulst_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_xright_d0)/numsims
verhulst_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_xright_d0)/numsims

verhulst_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_mleft_d0)/numsims
verhulst_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_mleft_d0)/numsims

verhulst_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=verhulst_extrisk_d0$risk_mright_d0)/numsims
verhulst_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=verhulst_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"verhulst_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(verhulst_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xleft,x1=verhulst_extrisk_d0$r,
       y1=verhulst_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_verhulst,lty="dotted",col="black")

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xright_d0,col="blue",type="b",pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Verhulst"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Verhulst",paste0("K =1, sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"verhulst_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(verhulst_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mleft,x1=verhulst_extrisk_d0$r,
       y1=verhulst_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_verhulst,lty="dotted",col="black")

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mright_d0,col="blue",type="b",pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Verhulst"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Verhulst",paste0("K =1, sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"verhulst_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(verhulst_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xleft,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_verhulst,lty="dotted",col="black")

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mleft,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025mright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(verhulst_extrisk_d0$r,verhulst_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=verhulst_extrisk_d0$r,y0=verhulst_extrisk_d0$CI0.025xright,
       x1=verhulst_extrisk_d0$r,y1=verhulst_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Verhulst"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r sim_abrewer_scl_0.6, echo=F,  cache=T, cache.extra=list(seed,srho_common,mtime("mydispersal.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("mydispersal.R")

model<-"austinbrewer"
scl<-0.6
srho<-srho_common

tempo<-paste("./Results/",model,"_scl_",scl,sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}
resloc<-paste(tempo,"/",sep="")

numsims<-10000
numsteps<-25
numlocs<-5
s<-0.2
K<-50

rc_abrewer<-1/(K*(1-exp(-s*K))) # transition from under to overcompensatory dynamics
r_bf_abrewer<-2*rc_abrewer # bifurcation parameter stable to unstable eqm

rng1<-runif(10000,min=0,max=r_bf_abrewer)
qr1<-quantile(rng1,probs=c(.025,.975))
q1<-abs(unname(qr1[1])-rc_abrewer)
q2<-abs(unname(qr1[2])-rc_abrewer)
qs<-c(q1,q2)
iqmin<-which.min(qs)
iqmax<-which.max(qs)

fromr<-range(qr1)[iqmin]
tor<-range(qr1)[iqmax]

if(fromr>tor){
  byr<--qs[iqmin]/4
}else{
  byr<-qs[iqmin]/4
}

rlist<-sort(seq(from=fromr,to=tor, by = byr))

xx<-diff(rlist)
vxx<-var(xx)

if(vxx>1e-10){
  warning("Not equal spacing in rlist : Austin-Brewer model !!!",immediate.=T,call.=T)
}

abrewer_extrisk_d0<-data.frame(rlist,NA*numeric(length(rlist)),NA*numeric(length(rlist)),
                               NA*numeric(length(rlist)),NA*numeric(length(rlist))) #initiate a dataframe to store 
                                                                         # ext risk at dispersal d=0 for all r
colnames(abrewer_extrisk_d0)<-c("r","risk_xleft_d0","risk_xright_d0","risk_mleft_d0","risk_mright_d0")

#for local dispersal in D matrix 
res_abrewer_local<-c()

for(i in c(1:length(rlist))){
  r<- rlist[i]
  p0<-K
  params<-c(r,K,s)
  ext_thrs<-p0/10
  
  ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
               scl=scl,srho=srho,model=model,disp_everywhere=F,plotteron = F,resloc=resloc, getacf=F)
  
  temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
  res_abrewer_local<-abind(res_abrewer_local,temp_mat,along = 3)
  
  abrewer_extrisk_d0$risk_xleft_d0[i]<-ss$risk_xleft[1]
  abrewer_extrisk_d0$risk_xright_d0[i]<-ss$risk_xright[1]
  
  abrewer_extrisk_d0$risk_mleft_d0[i]<-ss$risk_mleft[1]
  abrewer_extrisk_d0$risk_mright_d0[i]<-ss$risk_mright[1]
}

anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_abrewer_local)<-list(NULL,cnm,anm)

saveRDS(abrewer_extrisk_d0,paste(resloc,"abrewer_extrisk_d0.RDS",sep=""))
saveRDS(res_abrewer_local,paste(resloc,"res_abrewer_local.RDS",sep=""))

# For global dispersal in D matrix 
res_abrewer_global<-c()
for(r in rlist){
  p0<-K
  params<-c(r,K,s)
  ext_thrs<-p0/10
  
  ss<-varying_d(numsims=numsims,numsteps=numsteps,numlocs=numlocs,p0=p0,params=params,ext_thrs=ext_thrs,
               scl=scl,srho=srho,model=model,disp_everywhere=T,plotteron = F,resloc=resloc, getacf=F)
  
  temp_mat<-cbind(ss$d_seq,ss$risk_xleft,ss$risk_xright,ss$risk_mleft,ss$risk_mright)
  res_abrewer_global<-abind(res_abrewer_global,temp_mat,along = 3)
}
anm<-paste("r_",rlist,sep="")
cnm<-c("d","risk_xleft","risk_xright","risk_mleft","risk_mright")
dimnames(res_abrewer_global)<-list(NULL,cnm,anm)
saveRDS(res_abrewer_global,paste(resloc,"res_abrewer_global.RDS",sep=""))
```

```{r fig_abrewer_scl_0.6, echo=F, results="hide",cache=T, cache.extra=list(seed,res_abrewer_local,res_abrewer_global)}
#-------------------------------------- plot for extreme tail dep. noise ---------------------------------------
pdf(paste(resloc,"abrewer_ext_risk_local_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_local)[3]){
  ss<-res_abrewer_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"abrewer_ext_risk_global_disp_extremenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_global)[3]){
  ss<-res_abrewer_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#-------------------------------------- plot for moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"abrewer_ext_risk_local_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_local)[3]){
  ss<-res_abrewer_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"abrewer_ext_risk_global_disp_moderatenoise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_global)[3]){
  ss<-res_abrewer_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_mleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()

#--------------------- plot for extreme and moderate tail dep. noise --------------------------------------
pdf(paste(resloc,"abrewer_ext_risk_local_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_local)[3]){
  ss<-res_abrewer_local[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()


pdf(paste(resloc,"abrewer_ext_risk_global_disp_extreme_and_moderate_noise.pdf",sep=""),height=9,width=9)
op<-par(mfrow=c(3,3),mar=c(5,4,1.5,1.5),mgp=c(2,0.5,0))

for(i in 1:dim(res_abrewer_global)[3]){
  ss<-res_abrewer_global[,,i][1:6,] # plot for d in range (0 to 0.5)
  ss<-as.data.frame(ss)
  
  plot(ss$d,ss$risk_xleft,xlim=range(ss$d),ylim=c(0,1),type="b",col="red",
       xlab="d",ylab="Extinction risk",cex.lab=2,cex.axis=1.5)
  lines(ss$d,ss$risk_mleft,type="b",col="orange")
  lines(ss$d,ss$risk_mright,type="b",col="skyblue")
  lines(ss$d,ss$risk_xright,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[i],5)),cex=1.2)
}
par(op)
dev.off()
```

```{r fig_abrewer_extrisk_d0_scl_0.6, echo=F,results="hide"}
set.seed(seed)
numsims<-10000
abrewer_extrisk_d0<-readRDS(paste(resloc,"abrewer_extrisk_d0.RDS",sep=""))

abrewer_extrisk_d0$CI0.025xleft<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_xleft_d0)/numsims
abrewer_extrisk_d0$CI0.975xleft<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_xleft_d0)/numsims
abrewer_extrisk_d0$CI0.025xright<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_xright_d0)/numsims
abrewer_extrisk_d0$CI0.975xright<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_xright_d0)/numsims

abrewer_extrisk_d0$CI0.025mleft<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_mleft_d0)/numsims
abrewer_extrisk_d0$CI0.975mleft<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_mleft_d0)/numsims
abrewer_extrisk_d0$CI0.025mright<-qbinom(p=0.025,size=numsims,prob=abrewer_extrisk_d0$risk_mright_d0)/numsims
abrewer_extrisk_d0$CI0.975mright<-qbinom(p=0.975,size=numsims,prob=abrewer_extrisk_d0$risk_mright_d0)/numsims

pdf(paste(resloc,"abrewer_extrisk_d0_extremenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(abrewer_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xleft,x1=abrewer_extrisk_d0$r,
       y1=abrewer_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_abrewer,lty="dotted",col="black")

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xright_d0,col="blue",type="b",pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Austin-Brewer"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("s = ",s,", K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Austin-Brewer",paste0("s = ",s," , K = ",K),paste0(" sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

pdf(paste(resloc,"abrewer_extrisk_d0_moderatenoise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))
plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mleft_d0,col="red",type="b",ylim=c(0,1),
     xlim = range(abrewer_extrisk_d0$r),xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mleft,x1=abrewer_extrisk_d0$r,
       y1=abrewer_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_abrewer,lty="dotted",col="black")

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mright_d0,col="blue",type="b",pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="blue",code=3)
legend("topleft", legend=c("Austin-Brewer"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("s = ",s,", K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)
#legend("bottomright", c("Austin-Brewer",paste0("s = ",s," , K = ",K),paste0(" sd =",scl)), horiz=F, bty='n',cex=1.8)
par(op)
dev.off()

#-------------------- plot for extreme and moderate tail dep. noise ---------------------------------------
pdf(paste(resloc,"abrewer_extrisk_d0_extreme_and_moderate_noise.pdf",sep=""),height=5,width=5)
op<-par(mar=c(5,4,1.5,1.5),mgp=c(2,0.7,0))

plot(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xleft_d0,col="red",type="b",ylim=c(0,1),xlim = range(abrewer_extrisk_d0$r),
     xlab="r",ylab="Extinction risk",cex.lab=2,cex.axis=1.5,pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xleft,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975xleft,angle=90,length=0.1,col="red",code=3)
abline(v=rc_abrewer,lty="dotted",col="black")

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mleft_d0,col="orange",type="b",ylim=c(0,1),pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mleft,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975mleft,angle=90,length=0.1,col="orange",code=3)

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_mright_d0,col="skyblue",type="b",ylim=c(0,1),pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025mright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975mright,angle=90,length=0.1,col="skyblue",code=3)

lines(abrewer_extrisk_d0$r,abrewer_extrisk_d0$risk_xright_d0,col="blue",type="b",ylim=c(0,1),pch=1)
arrows(x0=abrewer_extrisk_d0$r,y0=abrewer_extrisk_d0$CI0.025xright,
       x1=abrewer_extrisk_d0$r,y1=abrewer_extrisk_d0$CI0.975xright,angle=90,length=0.1,col="blue",code=3)

legend("topleft", legend=c("Austin-Brewer"), horiz=F, bty='n',cex=1.8)  
mtext(paste0("s = ",s,", K = ",K),side = 3, line=-16, adj=0.9, cex=1.8, col="black")
legend("bottomright",legend=bquote(sigma==.(scl)), horiz=F,bty='n',cex=1.8)

par(op)
dev.off()
```

```{r create_maintext_fig_localdisp_summary,echo=F,results="hide"}

getplot<-function(x,rlist,noisetype){
  lasta<-dim(x)[3]
Af<-as.data.frame(x[,,1][1:6,])
Al<-as.data.frame(x[,,lasta][1:6,])

if(noisetype=="both"){
   plot(Af$d,Af$risk_xleft,xlim=range(Af$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
   lines(Af$d,Af$risk_mleft,type="b",col="orange")
   lines(Af$d,Af$risk_mright,type="b",col="skyblue")
   lines(Af$d,Af$risk_xright,type="b",col="blue")

  mtext(paste0("r = ", round(rlist[1],5)))

  plot(Al$d,Al$risk_xleft,xlim=range(Al$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
   lines(Al$d,Al$risk_mleft,type="b",col="orange")
   lines(Al$d,Al$risk_mright,type="b",col="skyblue")
   lines(Al$d,Al$risk_xright,type="b",col="blue")
   
  mtext(paste0("r = ", round(rlist[lasta],5)))
  
 }else if(noisetype=="extreme"){
  risk_left1<-Af$risk_xleft
  risk_right1<-Af$risk_xright
  
  risk_left2<-Al$risk_xleft
  risk_right2<-Al$risk_xright
  
  plot(Af$d,risk_left1,xlim=range(Af$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
   lines(Af$d,risk_right1,type="b",col="blue")

  mtext(paste0("r = ", round(rlist[1],5)))

  plot(Al$d,risk_left2,xlim=range(Al$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(Al$d,risk_right2,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[lasta],5)))
  
 }else if(noisetype=="moderate"){
  risk_left1<-Af$risk_mleft
  risk_right1<-Af$risk_mright
  
  risk_left2<-Al$risk_mleft
  risk_right2<-Al$risk_mright
  
  plot(Af$d,risk_left1,xlim=range(Af$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(Af$d,risk_right1,type="b",col="blue")

  mtext(paste0("r = ", round(rlist[1],5)))

  plot(Al$d,risk_left2,xlim=range(Al$d),ylim=c(0,1),type="b",col="red",
     xlab="d",ylab="Extinction risk",cex.lab=1.5,cex.axis=1.5)
  lines(Al$d,risk_right2,type="b",col="blue")
  mtext(paste0("r = ", round(rlist[lasta],5)))
  
 }else{
  cat("specify noisetype argument!")
  }
}
#------------- for extreme tail dep. noise : local dispersal ---------------------
pdf("./Results/allmodel_ext_risk_local_disp_extremenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_local
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: extreme LTdep.","noise: extreme RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
#mtext(paste("(K = 50, sd = 1)"), side = 3, line=-8.2, adj=0.6, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist,noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_local
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_local
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_local
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_local
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_local
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist,noisetype = "extreme")

par(op)
dev.off()

#------------- for moderate tail dep. noise : local dispersal ---------------------
pdf("./Results/allmodel_ext_risk_local_disp_moderatenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_local
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: moderate LTdep.","noise: moderate RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
#mtext(paste("(K = 50, sd = 1)"), side = 3, line=-8.2, adj=0.6, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist,noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_local
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_local
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_local
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_local
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_local
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist,noisetype = "moderate")

par(op)
dev.off()

#------------- for extreme and moderate tail dep. noise : local dispersal summary fig. -------------------
pdf("./Results/allmodel_ext_risk_local_disp_extreme_and_moderate_noise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_local
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend(x=0.6,y=1.3, c("extreme LT","moderate LT","moderate RT","extreme RT"), lty=c(1,1,1,1), pch=c(1,1,1.1), 
       col=c('red', 'orange','skyblue','blue'), horiz=F, bty='n', cex=1.6, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-9, adj=0.3, cex=1, col="black")
#mtext(paste("(K = 50, sd = 1)"), side = 3, line=-8.2, adj=0.6, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-11, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist,noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_local
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_local
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_local
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_local
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_local
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist,noisetype = "both")

par(op)
dev.off()
```
 
```{r create_maintext_fig_globaldisp_summary,echo=F,results="hide"}

#------------- for extreme tail dep. noise ---------------------

pdf("./Results/allmodel_ext_risk_global_disp_extremenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_global
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: extreme LTdep.","noise: extreme RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0,x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_global
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_global
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_global
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_global
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_global
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "extreme")

par(op)
dev.off()

#--------------------for moderate tail dep. noise -----------------------

pdf("./Results/allmodel_ext_risk_global_disp_moderatenoise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_global
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend("topleft", c("noise: moderate LTdep.","noise: moderate RTdep."), lty=c(1,1), pch=c(1,1), 
       col=c('red', 'blue'), horiz=F, bty='o', cex=1.5, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_global
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_global
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_global
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_global
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_global
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "moderate")

par(op)
dev.off()

#--------------------for extreme and moderate tail dep. noise : global dispersal summary fig-----------------------

pdf("./Results/allmodel_ext_risk_global_disp_extreme_and_moderate_noise.pdf",height=12,width=9)

op<-par(mfrow=c(6,3),mar=c(5.2,4.2,1.2,1.5))

x<-res_ricker_global
rlist<-ricker_extrisk_d0$r

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
legend(x=0.6,y=1.3, c("extreme LT","moderate LT","moderate RT","extreme RT"), lty=c(1,1,1,1), pch=c(1,1,1.1), 
       col=c('red', 'orange','skyblue','blue'), horiz=F, bty='n', cex=1.6, adj=0, x.intersp=0.2)
mtext(paste("Ricker model: "), side = 3, line=-9, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 50, ", sigma,"=1 )" )),side = 3, line=-11, adj=0.6, cex=1, col="black")
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Hassell model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 100, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_hassell_global
rlist<-hassell_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Maynard Smith model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.5, b = 4, ", sigma,"=0.8 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_msmith_global
rlist<-msmith_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Pennycuick model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( a = 0.1, b = 0.1, ", sigma,"=1 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_pennycuick_global
rlist<-pennycuick_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Verhulst model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( K = 1, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_verhulst_global
rlist<-verhulst_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

plot(1, 0, bty = "n", xaxt = "n", yaxt = "n",xlab="",ylab="",type="n")
mtext(paste("Austin-Brewer model: "), side = 3, line=-7, adj=0.3, cex=1, col="black")
mtext(expression( paste("( s = 0.2, K = 50, ", sigma,"=0.6 )" )),side = 3, line=-9, adj=0.6, cex=1, col="black")
x<-res_abrewer_global
rlist<-abrewer_extrisk_d0$r
getplot(x=x,rlist = rlist, noisetype = "both")

par(op)
dev.off()
``` 

```{r make_tab_model_summary,echo=F}
library(tibble)

dt1 <- tibble("Models"= c("Ricker",
           "Hassell",
           "Maynard Smith",
           "Pennycuick",
           "Verhulst",
           "Austin-Brewer")
)

dt2<-tibble("$\\lambda_i(t)$" = c("$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} \\exp[r (1-P_i(t)/K)$]",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} r/(1+aP_i(t))^b$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} r/[1+(aP_i(t))^b]$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} r/[1+\\exp \\{-a(1-P_i(t)/b)\\}]$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} [1+r(1-P_i(t)/K)]$",
                          "$\\exp(\\epsilon_i(t)) \\hspace{0.1 cm} [1+r(K-P_i(t))\\{1-\\exp(-sP_i(t))\\}]$"
))

dt3<-tibble("\\hspace{-0.1 cm} Parameters used" = c("K = 50, $\\sigma$ = 1",
                            "a = 0.5, b = 100, $\\sigma$ = 1",
                            "a = 0.5, b = 4, $\\sigma$ = 0.8",
                           "a = 0.1, b= 0.1, $\\sigma$ = 1",
                           "K = 1, $\\sigma$ = 0.6",
                           "s = 0.2, K = 50, $\\sigma$ = 0.6"
))

dt4<-tibble("$P_{e}$" = c("K",
                        "$(r^{1/b}-1)/a$",
                        "$[(r-1)^{1/b}]/a$",
                        "$[b\\{a+ln(r-1)\\}]/a$",
                        "K",
                        "K"
))

dt4_2<-tibble("$r_{min}$" = c("0",
                        "1",
                        "1",
                        "1.90",
                        "0",
                        "0"
))

dt5<-tibble("$r_{c}$" = c(rc_ricker,
                        rc_hassell,
                        rc_msmith,
                        rc_pennycuick,
                        rc_verhulst,
                        rc_abrewer
))

dt6<-tibble("$r_{bf}$" = c(r_bf_ricker,
                           r_bf_hassell,
                           r_bf_msmith,
                           r_bf_pennycuick,
                           r_bf_verhulst,
                           r_bf_abrewer
))

dt<-cbind(dt1,dt2,dt3,dt4,dt4_2,dt5,dt6)
saveRDS(dt,"./Results/tab_model_summary.RDS")
```


<!--FIG:  age structure model results for moderate tail dep. (C, SC)
\begin{figure}[!h]
\begin{center}
\textbf{ \hspace{0.5 cm} (A) \hspace{4.4 cm} (B)} \\
\vspace{-0.2 cm}
\includegraphics[width=5 cm]{./Results/age_str_results/extrisk_age_str_C_SC_linear.pdf}
\includegraphics[width=5 cm]{./Results/age_str_results/extrisk_age_str_C_SC_nonlinear_omg_100.pdf}
\caption[Extinction risk from single patch age structured models with time when vital rates have either left (C) or right tail (SC) association.]{Extinction risk (shading represents 95\% confidence interval) from single patch age structured models with time for 10000 simulations. Fecundity of adults and survival of eggs have moderate tail association in either left or right tail in their corresponding copula structure. Moderate left tail association (or right tail association) was generated by a bivariate Clayton (or Survival Clayton) copula with Kendall correlation coefficient = 0.6, $(A)$ for linear model ($\Omega = \infty$) and for $(B)$ non-linear model ($\Omega = 100$).\label{fig_extrisk_agestr_mtd}}
\end{center}
\end{figure}-->


<!--FIG:  summary: all nonlinear model results for global dispersion: extrisk vs. d-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=15 cm]{./Results/allmodel_ext_risk_global_disp_extreme_and_moderate_noise.pdf}
\caption[Extinction risk v. tail association and $d$: metapopulations, global dispersal]{Analogous to Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text, but using global dispersal between habitat patches.\label{fig_extrisk_allmodel_globaldisp}}
\end{center}
\end{figure}


<!--FIG: Ricker model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/ricker_scl_1/ricker_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, local dispersal, Ricker]{Analogous to Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text, but considering more values of $r$ and only the Ricker model.\label{fig_ricker_risk_local_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG : Hassell model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/hassell_scl_1/hassell_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, local dispersal, Hassell]{Analogous to Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text, but considering more values of $r$ and only the Hassell model. \label{fig_hassell_risk_local_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG: Maynard smith model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/msmith_scl_0.8/msmith_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, local dispersal, Maynard Smith]{Analogous to Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text, but considering more values of $r$ and only the Maynard Smith model. \label{fig_msmith_risk_local_disp_scl_0.8}}
\end{center}
\end{figure}

<!--FIG: Pennycuick model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/pennycuick_scl_1/pennycuick_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, local dispersal, Pennycuick]{Analogous to Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text, but considering more values of $r$ and only the Pennycuick model. \label{fig_risk_local_disp_pennycuick_r_vary_scl_1}}
\end{center}
\end{figure}

<!--FIG: Verhulst model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/verhulst_scl_0.6/verhulst_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, local dispersal, Velhurst]{Analogous to Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text, but considering more values of $r$ and only the Velhurst model. \label{fig_risk_local_disp_verhulst_r_vary_scl_0.6}}
\end{center}
\end{figure}

<!--FIG: Austin-Brewer model, local dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/austinbrewer_scl_0.6/abrewer_ext_risk_local_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, local dispersal, Austin-Brewer]{Analogous to Fig. \ref{MT-fig_extrisk_allmodel_localdisp} in the main text, but considering more values of $r$ and only the Austin-Brewer model. \label{fig_risk_local_disp_abrewer_r_vary_scl_0.6}}
\end{center}
\end{figure}


<!--FIG : Ricker model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=12 cm]{./Results/ricker_scl_1/ricker_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, global dispersal, Ricker]{Analogous to Fig. \ref{fig_ricker_risk_local_disp_scl_1} but for global dispersal between habitat patches. \label{fig_ricker_risk_global_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG: Hassell model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/hassell_scl_1/hassell_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, global dispersal, Hassell]{Analogous to Fig. \ref{fig_hassell_risk_local_disp_scl_1} but for global dispersal between habitat patches. \label{fig_hassell_risk_global_disp_scl_1}}
\end{center}
\end{figure}

<!--FIG: Maynard smith model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/msmith_scl_0.8/msmith_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, global dispersal, Maynard Smith]{Analogous to Fig. \ref{fig_msmith_risk_local_disp_scl_0.8} but for global dispersal between habitat patches. \label{fig_msmith_risk_global_disp_scl_0.8}}
\end{center}
\end{figure}

<!--FIG: Pennycuick model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/pennycuick_scl_1/pennycuick_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, global dispersal, Pennycuick]{Analogous to Fig. \ref{fig_risk_local_disp_pennycuick_r_vary_scl_1} but for global dispersal between habitat patches. \label{fig_risk_global_disp_pennycuick_r_vary_scl_1}}
\end{center}
\end{figure}

<!--FIG: Verhulst model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/verhulst_scl_0.6/verhulst_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, global dispersal, Velhurst]{Analogous to Fig. \ref{fig_risk_local_disp_verhulst_r_vary_scl_0.6} but for global dispersal between habitat patches. \label{fig_risk_global_disp_verhulst_r_vary_scl_0.6}}
\end{center}
\end{figure}

<!--FIG: Austin brewer model, global dispersal-->
\begin{figure}[!h]
\begin{center}
\includegraphics[width=12 cm]{./Results/common_legend_extreme_and_moderate_noise.pdf}\\
\includegraphics[width=15 cm]{./Results/austinbrewer_scl_0.6/abrewer_ext_risk_global_disp_extreme_and_moderate_noise.pdf}\\
\caption[Extinction risk v. tail association, $d$ and $r$: metapopulations, global dispersal, Austin-Brewer]{Analogous to Fig. \ref{fig_risk_local_disp_abrewer_r_vary_scl_0.6} but for global dispersal between habitat patches. \label{fig_risk_global_disp_abrewer_r_vary_scl_0.6}}
\end{center}
\end{figure}

# Generating noise with asymmetric tail associations  \label{makenoise}

<!--# Algorithm to generate extreme tail association  \label{extr_tail_dep}-->
Bivarite environmental noise with extreme left-tail association (as in Fig. 
\ref{MT-fig_intro_cop}A) was generated using an algorithm originally presented 
by @Ghosh_copula (their Appendix S10), presented again here for convenience.
If $T$ time steps of noise were desired, step 1 was to generate a $T$ by $2$
matrix, $M$, of independent random numbers, each standard-normally distributed. 
Then, each row of $M$ was identified for modification randomly and
independently, with a 50\% chance. For those rows identified, every element
of the row was replaced by the negative of the absolute value of the first element
of the row, including the first element itself. For the other rows, every 
element in the row was replaced by its own absolute value. For noise
with extreme right-tail association (as in Fig. 
\ref{MT-fig_intro_cop}D), take the negative of the entire matrix. For
both types of noise, every entry was transformed by the cumulative distribution
function of a standard normal distribution, to make each column uniformly
distributed.

<!--Spearman correlation of the extreme-tail-associated noise-->
The Spearman correlation of the extreme left- or right-tail associated 
noise was `r srho_common`, up to sampling variation.
<!--***DAN: Dan to fill this in with a derivation of this fact-->

<!--moderate tail association noise-->
Bivarite environmental noise with moderate left-tail association (as in Fig. \ref{MT-fig_intro_cop}B) was 
generated using a 2-dimensional Clayton copula. The statistical
theory of copulas has been introduced systematically in several texts 
(e.g., @nelsen2006_copula; @joe2014_dependence), and was briefly 
introduced by @Genest2007. Short, conceptual introductions aimed at ecological
audiences were provided by sections within the papers of @Anderson2018 and @Ghosh_copula. A
2-dimensional Clayton copula is equivalent to a particular bivariate 
probability density function with marginal distributions which are 
uniform on the interval $(0,1)$. The points on Fig. 
\ref{MT-fig_intro_cop}B were independent draws from the associated random variable.
The functions `claytonCopula` and `rCopula` from the `copula` package for the 
R programming language were used. The parameter of the Clayton family was
chosen so that the Spearman correlation was `r srho_common`, the same as that of the
extreme left-tail associated noise. This was accomplished with the `iRho`
function of the `copula` package. Noise with moderate right-tail
association was generated in a similar way but using the 2-dimensional 
survival Clayton copula.
<!--***DAN: Shyamolina, in response to your comment in the pdf, what you
did is mathematically equivalent to this, so OK to say it this way. I added a 
bit of explanation of what that survival Clayon is. Please delete this
comment once you have read it.-->
The survival Clayton copula is a rotation of the Clayton copula by 180 degrees.

<!--Multivariate extreme tail association-->
Multivariate noise with extreme left-tail association was generated using a
very simlar algorithm to the bivariate case,
as follows. If $T$ time steps of noise of dimension $n$ were desired,
step 1 was to generate a $T$ by $n$
matrix, $M$, of independent random numbers, each standard-normally distributed.
Each row of $M$ was identified for modification randomly and
independently, with a 50\% chance. For those rows identified, every element
of the row was replaced by the negative of the absolute value of the first element
of the row, including the first element itself. For the other rows, every 
element in the row was replaced by its own absolute value. For noise
with extreme right-tail association, take the negative of the entire matrix. For
both types of noise, every entry was transformed by the cumulative distribution
function of a standard normal distribution, to make each column uniformly
distributed. 
Multivariate moderately tail associated noise of dimension $n$
was generated using $n$-dimensional Clayton or survival Clayton copulas. 

# Stability analysis of deterministic metapopulation models  \label{model_stability}

Let $P(t+1) = F(P(t),r)$ be a deterministic population-dynamic model, where 
$P(t)$ is the population at time $t$ and $r$ is a model parameter. Let $P_e$
be an equilibrium (which may depend on $r$), i.e., $F(P_e,r)=P_e$. $P_e$
is called a stable equilibrium if, when the population is perturbed slightly
from equilibrium, the system returns to the equilibrium value; $P_e$ is called
an unstable equilibrium otherwise.
From standard linear stability analysis, we say an equilibrium is locally 
asymptotically stable if $| {F}' | < 1$, where ${F}' = \left( \frac{\mathrm{d}F }{\mathrm{d} P} \right) _{P=P_e}$.
If $0<{F}'<1$, then the approach of the system to the equilibrium is monotonic,
and dynamics are called undercompensatory. If $-1<{F}'<0$, then the approach of the
system to equilibrium is oscillatory, and dynamics are called overcompensatory. 
We will now describe stability analyses of the deterministic 1-habitat-patch version
of each model of Table \ref{MT-tab_model_summary}.

**The Ricker model.** The Ricker model was originally introduced in the context of modelling
the stock and recruitment of salmon populations, and has frequently been used in fisheries 
management. The model is 
$P(t+1)=F(P(t),r,K)=P(t) \exp[r(1-P(t)/K)]$, where $r>0$ is the intrinsic 
growth rate and $K>0$ is the carrying capacity of the population. There are two equilibrium 
states, $P_e = 0$ and $P_e = K$.
The equilibrium $P_e = 0$ is unstable, since ${F}' = \exp(r)$ for that equilibtrium, and 
$\exp(r) > 1$ for a positive $r$. Depending on $r$, 
the other equilibrium, $P_e = K$, can be stable or unstable, since ${F}' = (1-r)$. 
Specifically, $P_e=K$ is stable if $|1-r|<1$, i.e., $0<r<2$. 
The model shows undercompesatory dynamics if $0<r<1$ and overcompensatory dynamics
if $1<r<2$. Thus $r_{min}=0$, $r_c=1$, and $r_{bf}=2$.

**The Hassell model.** The Hassell model [@hassell1975density; @may1976bifurcations] was 
developed to help understand the dynamics of insect populations, and as a model of contest versus scramble 
instraspecific competition. The model
can be written $P(t+1) = F(P(t),r,a,b)=rP(t)/(1+aP(t))^b$. Here $r>0$ is the intrinsic growth rate and
$a$ and $b$ are positive parameters. If $b=1$, the Hassell model reduces to the
Beverton-Holt model [@beverton2012dynamics] used in fisheries. The Hassell model is a representation
of contest competition if $b \sim 1$, and scramble competition if $b$ is large.
Like the Ricker model, the Hassell model also has two equilibria, $P_e =0$ 
(the trivial extinction equilibrium) and $P_e = P^\star =(r^{1/b}-1)/a$. 
For $P_e = P^\star$, the model shows undercompensatory dymamics if $1<r<[b/(b-1)]^b$ 
and overcompensatory dynamics if $[b/(b-1)]^b<r<[b/(b-2)]^b$, so $r_{min}=1$, 
$r_c = [b/(b-1)]^b$, and $r_{bf}=[b/(b-2)]^b$.

**The Maynard Smith model.** The Maynard Smith 
model [@cohen1995unexpected; @maynard1978models; @may1976bifurcations] is
$P(t+1)=F(P(t),r,a,b)=rP(t)/[1+(aP(t))^b]$. Here $r>0$ is the growth rate and $a, b$ are 
positive parameters. The equilibria are $P_e=0$ (the extinction equilibrium) 
and $P_e = P^\star=\frac{1}{a}(r-1)^{1/b}$.
For a positive equilibrium value of $P^\star$, $r$ must be greater than $1$, so $r_{min}=1$. 
Then $P^\star$ will 
be a stable equilibrium and the model will show undercompensatory dynamics if $1<r<r_c=b/(b-1)$;
the model will show overcompensatory dymamics $r_c<r<b/(b-2)$.
$P^\star$ will become unstable for $r>r_{bf}=b/(b-2)$. 

**The Pennycuick model.** The Pennycuick model [@pennycuick1968computer; @may1976bifurcations] 
is $P(t+1)=F(P(t),r,a,b)=rP(t)/[1+\exp \left\{-a(1-P(t)/b)\right\}]$, where 
$r>0$ is the intrinsic growth rate and $a$ and $b$ are positive parameters. Model
equilibria are 
$P_e=0$ (the extinction equilibrium) and $P_e=P^\star=\frac{b}{a}[a+\ln{(r-1)}]$. For 
a positive equilibrium population 
$r$ must be greater than $r_{min} = 1+\exp(-a)$. The transition point $r_c$ (from under- to 
overcompensatory dynamics) and the bifurcation point $r_{bf}$ were obtained
by numerical solution of ${F}'=0$ and ${F}'=-1$ at $P_e=P^{\star}$, respectively.

**The Verhulst model.** The Velhurst model 
[@cohen1995unexpected; @may1976bifurcations] is a discrete-time 
representation of logistic growth, and can be written 
as $P(t+1) = F(P(t),r,K) =P(t)[1+r(1-P(t)/K)]$, with $r>0$ and $K>0$ being growth rate and 
carrying capacity parameters, respectively. 
The model equilibrium $P_e=0$ is always unstable whereas the equilibrium 
$P_e=K$ is stable below the bifurcation 
point $r_{bf}=2$. The model shows undercompensatory dynamics for $0<r<r_c=1$
and overcompensatory dynamics for $r_c<r<r_{bf}$.

**The Austin-Brewer model.** The Austin-Brewer model 
[@austin1971world; @cohen1995unexpected] was originally used 
to model the growth of human populations. The model is $P(t+1) = F(P(t),r,K,s)= P(t)[1+r(K-P(t)) \left\{ 1-\exp (-sP(t))\right\}]$, where
$r, K, s$ are positive parameters. $r$ and $K$ represent the growth rate and carrying 
capacity, respectively.
the usual extinction equilibrium is $P_e=0$. The 
positive equilibrium is $P_e=P^\star=1-rK\left\{ 1-\exp (-sK)\right\}$. $P^\star$
is stable when $r<r_{bf}$ and unstable beyond the bifurcation point, where 
$r_{bf} = \frac{2}{K[1-\exp (-sK)]}$. The model shows undercompensatory dynamics when
$0<r<r_c$, where $r_c = \frac{1}{K[1-\exp (-sK)]}$. It shows 
overcompensatory dynamics when $r_c<r<r_{bf}$.

\clearpage

# References 
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{1pt}
\noindent













