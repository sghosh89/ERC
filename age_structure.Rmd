---
title: "extinction risk with one patch age structured model"
author: "Shyamolina Ghosh"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
seed<-101
source("mtime.R")
```

# Age structure model :

```{r sim_linear_C_SC_G_SG, echo=F,  cache=T, cache.extra=list(seed,mtime("ext_risk_cop_age_str.R"))}
set.seed(seed)
source("ext_risk_cop_age_str.R")

numsims<-10000
numsteps<-100
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-Inf

ktau<-0.6  # kendall's tau

# for clayton
copC<-claytonCopula(3)
parC<-iTau(copC,tau=ktau)
par<-parC
fam<-3

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_ktau_",ktau,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

C_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(C_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
#---------------------------------------------------------------------------------

# Now for survival clayton : should be the same parameter as of clayton if kendall's tau is the same 

fam<-13
par<-parC

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_ktau_",ktau,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

SC_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(SC_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
#---------------------------------------------------------------------------------

# Now for gumbel 

fam<-4
copG<-gumbelCopula(2)
parG<-iTau(copG,tau = ktau)
par<-parG

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_ktau_",ktau,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

G_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(G_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))

#---------------------------------------------------------------------------------

# Now for survival gumbel : should be the same parameter as of gumbel if kendall's tau is the same 

fam<-14
par<-parG

cop<-BiCopSim(N=(numsteps*numsims), family = fam, par = par)

tempo<-paste("./Results/age_str_results/",BiCopName(family=fam),"_par_",par,"_ktau_",ktau,"_linear",sep="")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

SG_age<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(SG_age,paste(resloc,BiCopName(family = fam),"_sim_age_str.RDS",sep=""))
#---------------------------------------------------------------------------------
```

```{r fig_extrisk_linear_agestr_C_SC_G_SG, echo=F,results="hide"}

res_agel_C<-readRDS("./Results/age_str_results/C_par_3_ktau_0.6_linear/C_sim_age_str.RDS")
res_agel_SC<-readRDS("./Results/age_str_results/SC_par_3_ktau_0.6_linear/SC_sim_age_str.RDS")
res_agel_G<-readRDS("./Results/age_str_results/G_par_2.5_ktau_0.6_linear/G_sim_age_str.RDS")
res_agel_SG<-readRDS("./Results/age_str_results/SG_par_2.5_ktau_0.6_linear/SG_sim_age_str.RDS")

xC<-res_agel_C$extdf
xSC<-res_agel_SC$extdf
xG<-res_agel_G$extdf
xSG<-res_agel_SG$extdf

t<-c(0:(nrow(xC)-1))

pdf(paste("./Results/age_str_results/extrisk_age_str_C_SC_G_SG_ktau_",ktau,"_linear.pdf",sep=""),height=6,width=12)
op<-par(mfrow=c(1,2),mar=c(4,4,2,2),mgp=c(2.5,0.5,0))

# for C, SC
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=1.5,panel.first=grid())

x<-xC
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,0,0.3), border = NA)
lines(t,x$erA,col="black",type="l")

x<-xSC
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")

legend("topleft", c("C","SC"), lty=c(1,1),  
       col=c('black', 'red'), horiz=F, bty='n', cex=1.2)

# for G, SG
plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=1.5,panel.first=grid())

x<-xG
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,0,0.3), border = NA)
lines(t,x$erA,col="black",type="l")

x<-xSG
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")

legend("topleft", c("G","SG"), lty=c(1,1),  
       col=c('black', 'red'), horiz=F, bty='n', cex=1.2)

par(op)
dev.off()
```


![Extinction risk from one patch age structured model, fecundity of adults and survival of eggs have different asymmetric copula atructure but with same kendall correlation = 0.6, numsims=10000.\label{fig_extrisk_agestr}](./Results/age_str_results/extrisk_age_str_C_SC_G_SG_ktau_0.6_linear.pdf){ width=40%, height=40% }


```{r sim_agestr_with_extremetail_linear, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("ext_risk_cop_age_str.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("ext_risk_cop_age_str.R")
source("ExtremeTailDep.R")

numsims<-10000
numsteps<-100
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-Inf

# For extreme right tail dep.
mr<-retd(n = (numsteps*numsims),d = 2,rl =1,mn=0,sdev=1)
cop<-pnorm(mr) # to make normal to uniformly distributed

tempo<-paste("./Results/age_str_results/extreme_right_taildep_linear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

pdf(paste(resloc,"extreme_right_tail_cop.pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()

las_exR<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(las_exR,paste(resloc,"sim_age_str_extreme_right_taildep.RDS",sep=""))

# For extreme left tail dep.
ml<-retd(n = (numsteps*numsims),d = 2,rl =-1,mn=0,sdev=1)
cop<-pnorm(ml) # to make normal to uniformly distributed

tempo<-paste("./Results/age_str_results/extreme_left_taildep_linear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

pdf(paste(resloc,"extreme_left_tail_cop.pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()

las_exL<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(las_exL,paste(resloc,"sim_age_str_extreme_left_taildep.RDS",sep=""))
```


```{r fig_agestr_with_extremetail_linear, echo=F,results="hide"}

xL<-las_exL$extdf
xR<-las_exR$extdf

t<-c(0:(nrow(xL)-1))

pdf(paste("./Results/age_str_results/extrisk_age_str_extremetail_linear.pdf",sep=""),height=6,width=6)
op<-par(mar=c(4,4,2,2),mgp=c(2.5,0.5,0))

plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=1.5,panel.first=grid())

x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,0,0.3), border = NA)
lines(t,x$erA,col="black",type="l")

x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")

legend("topleft", c("Left tail","Right tail"), lty=c(1,1),  
       col=c('black', 'red'), horiz=F, bty='n', cex=1.2)
par(op)
dev.off()
```

![Extinction risk from one patch linear age structured model (omg=Infinity), fecundity of adults and survival of eggs have either extreme left or extreme right tail dep. copula structure, numsims=10000.\label{fig_extrisk_lagestr_extremetail}](./Results/age_str_results/extrisk_age_str_extremetail_linear.pdf){ width=40%, height=40% }


```{r sim_agestr_with_extremetail_nonlinear, echo=F,  results="hide", cache=T, cache.extra=list(seed,mtime("ext_risk_cop_age_str.R"),mtime("ExtremeTailDep.R"))}
set.seed(seed)
source("ext_risk_cop_age_str.R")
source("ExtremeTailDep.R")

numsims<-10000
numsteps<-100
p0<-c(5,10)
ext_thrs<-2
gshape<-2
gscale<-1
bshape1<-3
bshape2<-2
par_dist<-c(gshape,gscale,bshape1,bshape2)
omg<-1000

# For extreme right tail dep.
mr<-retd(n = (numsteps*numsims),d = 2,rl =1,mn=0,sdev=1)
cop<-pnorm(mr) # to make normal to uniformly distributed

tempo<-paste("./Results/age_str_results/extreme_right_taildep_nonlinear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

pdf(paste(resloc,"extreme_right_tail_cop_omg_",omg,".pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()

nlas_exR<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(nlas_exR,paste(resloc,"sim_age_str_extreme_right_taildep.RDS",sep=""))

# For extreme left tail dep.
ml<-retd(n = (numsteps*numsims),d = 2,rl =-1,mn=0,sdev=1)
cop<-pnorm(ml) # to make normal to uniformly distributed

tempo<-paste("./Results/age_str_results/extreme_left_taildep_nonlinear")
if (!dir.exists(tempo)){
  dir.create(tempo)
}

resloc<-paste(tempo,"/",sep="")

pdf(paste(resloc,"extreme_right_tail_cop_omg_",omg,".pdf",sep=""),height = 5,width=5)
plot(cop[,1],cop[,2])
dev.off()

nlas_exL<-sim_age_str(p0=p0,ext_thrs = ext_thrs,cop=cop,par_dist = par_dist,omg=omg,
            numsims = numsims,numsteps = numsteps,ploton=T,resloc=resloc)
saveRDS(nlas_exL,paste(resloc,"sim_age_str_extreme_left_taildep.RDS",sep=""))
```


```{r fig_agestr_with_extremetail_nonlinear, echo=F,results="hide"}

xL<-nlas_exL$extdf
xR<-nlas_exR$extdf

t<-c(0:(nrow(xL)-1))

pdf(paste("./Results/age_str_results/extrisk_age_str_extremetail_nonlinear_omg_",omg,".pdf",sep=""),height=6,width=6)
op<-par(mar=c(4,4,2,2),mgp=c(2.5,0.5,0))

plot(0,-1,ylim=c(0,1),xlim=range(t),ylab="Extinction risk",xlab="time",cex.lab=1.5,panel.first=grid())

x<-xL
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(0,0,0,0.3), border = NA)
lines(t,x$erA,col="black",type="l")

x<-xR
polygon(c(rev(t), t), c(rev(x$CI0.975), x$CI0.025), col = rgb(1,0,0,0.3), border = NA)
lines(t,x$erA,col="red",type="l")

legend("topleft", c("Left tail","Right tail"), lty=c(1,1),  
       col=c('black', 'red'), horiz=F, bty='n', cex=1.2)
par(op)
dev.off()
```

![Extinction risk from one patch non-linear age structured model (omg=1000), fecundity of adults and survival of eggs have either extreme left or extreme right tail dep. copula structure, numsims=10000.\label{fig_extrisk_nlagestr_extremetail}](./Results/age_str_results/extrisk_age_str_extremetail_nonlinear_omg_1000.pdf){ width=40%, height=40% }



















